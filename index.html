<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Acompanhamento de Plantio - Versão Melhorada</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><text y='20' font-size='20'>🌱</text></svg>">
  
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      /* Enhanced Color Palette */
      --primary-color: #4CAF50;
      --primary-hover: #45a049;
      --primary-light: #E8F5E8;
      --secondary-color: #2196F3;
      --secondary-hover: #0b7dda;
      --secondary-light: #E3F2FD;
      --accent-color: #FF9800;
      --accent-hover: #e68a00;
      --danger-color: #f44336;
      --danger-hover: #da190b;
      --warning-color: #ff9800;
      --warning-hover: #e68a00;
      --success-color: #4CAF50;
      --info-color: #17a2b8;
      
      /* Neutral Colors */
      --text-dark: #2c3e50;
      --text-medium: #34495e;
      --text-light: #7f8c8d;
      --text-muted: #95a5a6;
      --border-color: #dfe6e9;
      --border-light: #ecf0f1;
      
      /* Background Colors */
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --bg-sidebar: #ffffff;
      --bg-header: #ffffff;
      --bg-overlay: rgba(0, 0, 0, 0.6);
      
      /* Shadow & Effects */
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
      --shadow-xl: 0 25px 50px rgba(0,0,0,0.25);
      
      /* Sizes & Spacing */
      --border-radius: 12px;
      --border-radius-sm: 8px;
      --border-radius-lg: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s ease;
      
      /* Typography */
      --font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;
    }

    /* Dark Theme Support */
    [data-theme="dark"] {
      --text-dark: #ecf0f1;
      --text-medium: #bdc3c7;
      --text-light: #95a5a6;
      --bg-body: #1a202c;
      --bg-card: #2d3748;
      --bg-sidebar: #2d3748;
      --bg-header: #2d3748;
      --border-color: #4a5568;
      --border-light: #4a5568;
    }

    /* Reset & Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: var(--font-family);
      background: var(--bg-body);
      color: var(--text-dark);
      line-height: 1.6;
      display: flex;
      min-height: 100vh;
      font-size: var(--font-size-base);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Enhanced Sidebar */
    .sidebar {
      width: 280px;
      background: var(--bg-sidebar);
      padding: 24px 20px;
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      transition: var(--transition);
    }

    .sidebar-header {
      text-align: center;
      padding: 20px 0;
      border-bottom: 2px solid var(--border-light);
      margin-bottom: 20px;
    }

    .sidebar-logo {
      font-size: var(--font-size-2xl);
      color: var(--primary-color);
      margin-bottom: 8px;
    }

    .sidebar-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-dark);
      margin: 0;
    }

    .sidebar-subtitle {
      font-size: var(--font-size-sm);
      color: var(--text-light);
      margin: 4px 0 0 0;
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: var(--transition);
    }

    /* Enhanced Header */
    .header {
      background: var(--bg-header);
      padding: 24px 32px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 20px;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header h1 {
      color: var(--primary-color);
      font-size: var(--font-size-2xl);
      font-weight: 700;
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Enhanced Statistics Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-card);
      padding: 24px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      text-align: center;
      transition: var(--transition);
      border: 1px solid var(--border-light);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
      transform: scaleX(0);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card:hover::before {
      transform: scaleX(1);
    }

    .stat-icon {
      font-size: var(--font-size-3xl);
      color: var(--primary-color);
      margin-bottom: 16px;
      display: block;
    }

    .stat-value {
      font-size: var(--font-size-3xl);
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 8px;
      display: block;
    }

    .stat-label {
      color: var(--text-light);
      font-size: var(--font-size-sm);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-change {
      font-size: var(--font-size-xs);
      margin-top: 8px;
      padding: 4px 8px;
      border-radius: 20px;
      font-weight: 500;
    }

    .stat-change.positive {
      background: rgba(76, 175, 80, 0.1);
      color: var(--success-color);
    }

    .stat-change.negative {
      background: rgba(244, 67, 54, 0.1);
      color: var(--danger-color);
    }

    .stat-change.neutral {
      background: rgba(33, 150, 243, 0.1);
      color: var(--secondary-color);
    }

    /* Enhanced Buttons */
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: var(--border-radius-sm);
      font-size: var(--font-size-sm);
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: white;
      background: var(--primary-color);
      text-decoration: none;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      min-height: 44px;
      justify-content: center;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: var(--transition);
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      background: var(--primary-hover);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-sidebar {
      width: 100%;
      justify-content: flex-start;
      background: transparent;
      color: var(--text-medium);
      border: 2px solid transparent;
      margin-bottom: 4px;
    }

    .btn-sidebar:hover {
      background: var(--primary-light);
      color: var(--primary-color);
      border-color: var(--primary-color);
      transform: translateX(4px);
    }

    .btn-sidebar.active {
      background: var(--primary-color);
      color: white;
    }

    .btn-secondary {
      background: var(--secondary-color);
    }

    .btn-secondary:hover {
      background: var(--secondary-hover);
    }

    .btn-warning {
      background: var(--warning-color);
    }

    .btn-warning:hover {
      background: var(--warning-hover);
    }

    .btn-danger {
      background: var(--danger-color);
    }

    .btn-danger:hover {
      background: var(--danger-hover);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary-color);
      border: 2px solid var(--primary-color);
    }

    .btn-outline:hover {
      background: var(--primary-color);
      color: white;
    }

    .btn i {
      font-size: var(--font-size-base);
      width: 20px;
      text-align: center;
    }

    /* Enhanced Form Controls */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 500;
      color: var(--text-dark);
      margin-bottom: 8px;
      font-size: var(--font-size-sm);
    }

    .form-control,
    .search-box {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      font-size: var(--font-size-base);
      transition: var(--transition);
      background: var(--bg-card);
      color: var(--text-dark);
    }

    .form-control:focus,
    .search-box:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .search-box {
      margin-bottom: 20px;
      position: relative;
    }

    .search-container {
      position: relative;
    }

    .search-container i {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
      font-size: var(--font-size-sm);
    }

    .search-container .form-control {
      padding-left: 44px;
    }

    /* Enhanced Table */
    .data-table-container {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border-light);
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 2px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-card);
    }

    .table-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-dark);
      margin: 0;
    }

    .table-actions {
      display: flex;
      gap: 12px;
    }

    .table-responsive {
      overflow-x: auto;
      flex: 1;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-sm);
      background: var(--bg-card);
    }

    .data-table th,
    .data-table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
      vertical-align: middle;
    }

    .data-table th {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      font-size: var(--font-size-sm);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .data-table th.sortable {
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
    }

    .data-table th.sortable:hover {
      background: var(--primary-hover);
    }

    .data-table tbody tr {
      transition: var(--transition);
    }

    .data-table tbody tr:hover {
      background: rgba(76, 175, 80, 0.05);
    }

    .data-table tbody tr:nth-child(even) {
      background: rgba(0, 0, 0, 0.02);
    }

    .data-table tbody tr:nth-child(even):hover {
      background: rgba(76, 175, 80, 0.05);
    }

    /* Enhanced Progress Bar */
    .progress-container {
      width: 100%;
      max-width: 200px;
    }

    .progress-bar {
      height: 24px;
      background: var(--border-light);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 12px;
      position: relative;
      overflow: hidden;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: 600;
      font-size: var(--font-size-xs);
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      z-index: 1;
    }

    /* Enhanced Modals */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-overlay);
      backdrop-filter: blur(8px);
      overflow: auto;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--bg-card);
      margin: 2% auto;
      padding: 0;
      border-radius: var(--border-radius-lg);
      width: 95%;
      max-width: 1200px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-xl);
      animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border-light);
    }

    @keyframes slideIn {
      from { 
        opacity: 0; 
        transform: translateY(-50px) scale(0.95); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
    }

    .modal-header {
      padding: 24px 32px;
      border-bottom: 2px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-card);
      border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
      position: relative;
    }

    .modal-header::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }

    .modal-title {
      margin: 0;
      color: var(--text-dark);
      font-size: var(--font-size-xl);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px 32px;
      background: var(--bg-card);
    }

    .modal-footer {
      padding: 20px 32px;
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      background: var(--bg-card);
      border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
    }

    .close-btn {
      color: var(--text-light);
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
      padding: 8px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .close-btn:hover {
      color: var(--danger-color);
      background: rgba(244, 67, 54, 0.1);
      transform: rotate(90deg);
    }

    /* Enhanced Tooltips */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip-text {
      visibility: hidden;
      width: 200px;
      background: var(--text-dark);
      color: white;
      text-align: center;
      border-radius: var(--border-radius-sm);
      padding: 12px;
      position: absolute;
      z-index: 9999;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: var(--transition);
      font-size: var(--font-size-xs);
      font-weight: 500;
      box-shadow: var(--shadow-lg);
    }

    .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -8px;
      border-width: 8px;
      border-style: solid;
      border-color: var(--text-dark) transparent transparent transparent;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Enhanced Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: var(--border-radius);
      color: white;
      font-weight: 500;
      z-index: 10000;
      box-shadow: var(--shadow-lg);
      transform: translateX(400px);
      transition: var(--transition);
      max-width: 400px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: var(--success-color);
    }

    .notification.error {
      background: var(--danger-color);
    }

    .notification.warning {
      background: var(--warning-color);
    }

    .notification.info {
      background: var(--info-color);
    }

    /* Footer Stats */
    .footer-stats {
      background: var(--primary-color);
      color: white;
      padding: 16px 32px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin-top: auto;
      box-shadow: var(--shadow-lg);
      border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .footer-stat {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .footer-stat i {
      font-size: var(--font-size-lg);
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .sidebar {
        width: 240px;
      }
      
      .main-content {
        margin-left: 240px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        box-shadow: none;
        border-bottom: 2px solid var(--border-light);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .header {
        padding: 16px 20px;
        flex-direction: column;
        align-items: stretch;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .modal-content {
        width: 98%;
        margin: 1% auto;
      }
      
      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 16px 20px;
      }
      
      .footer-stats {
        flex-direction: column;
        gap: 12px;
      }
    }

    /* Additional Utility Classes */
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-left { text-align: left; }
    
    .text-success { color: var(--success-color); }
    .text-danger { color: var(--danger-color); }
    .text-warning { color: var(--warning-color); }
    .text-info { color: var(--info-color); }
    .text-muted { color: var(--text-muted); }
    
    .bg-success { background-color: var(--success-color); }
    .bg-danger { background-color: var(--danger-color); }
    .bg-warning { background-color: var(--warning-color); }
    .bg-info { background-color: var(--info-color); }
    
    .d-none { display: none; }
    .d-block { display: block; }
    .d-flex { display: flex; }
    .d-grid { display: grid; }
    
    .mb-0 { margin-bottom: 0; }
    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .mb-3 { margin-bottom: 24px; }
    .mb-4 { margin-bottom: 32px; }
    
    .mt-0 { margin-top: 0; }
    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mt-3 { margin-top: 24px; }
    .mt-4 { margin-top: 32px; }
    
    /* Loading States */
    .loading {
      position: relative;
      overflow: hidden;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    /* Enhanced Charts Container */
    .chart-container {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow-md);
      margin-bottom: 24px;
      border: 1px solid var(--border-light);
    }
    
    .chart-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 20px;
      text-align: center;
    }

    /* Theme Toggle */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1001;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow-md);
    }
    
    .theme-toggle:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-lg);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--border-light);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-hover);
    }

    /* Editable stats */
    .stat-value.editable {
      cursor: pointer;
      border-bottom: 2px dashed var(--primary-color);
      transition: var(--transition);
    }

    .stat-value.editable:hover {
      background-color: rgba(76, 175, 80, 0.1);
    }

    .stat-value-input {
      width: 100%;
      font-size: var(--font-size-3xl);
      font-weight: 700;
      color: var(--primary-color);
      text-align: center;
      border: 2px solid var(--primary-color);
      border-radius: var(--border-radius-sm);
      background: var(--bg-card);
      padding: 4px;
    }

    /* Record badge */
    .record-badge {
      display: inline-block;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #fff;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      margin-left: 8px;
      vertical-align: middle;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Comparison stats */
    .comparison-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .comparison-card {
      background: var(--bg-card);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-light);
    }

    .comparison-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .comparison-value {
      font-size: var(--font-size-2xl);
      font-weight: 700;
      margin-bottom: 8px;
    }

    .comparison-label {
      color: var(--text-light);
      font-size: var(--font-size-sm);
    }

    .comparison-difference {
      margin-top: 12px;
      font-size: var(--font-size-sm);
      font-weight: 500;
    }

    .positive-diff {
      color: var(--success-color);
    }

    .negative-diff {
      color: var(--danger-color);
    }

    /* Comparison tabs */
    .comparison-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border-light);
      padding-bottom: 12px;
    }

    .comparison-tab {
      padding: 8px 16px;
      border-radius: var(--border-radius-sm);
      background: var(--border-light);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }

    .comparison-tab.active {
      background: var(--primary-color);
      color: white;
    }

    .comparison-tab:hover:not(.active) {
      background: var(--primary-light);
    }

    .comparison-content {
      display: none;
    }

    .comparison-content.active {
      display: block;
    }

    /* Week selector grid */
    .week-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .week-btn {
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      background: var(--bg-card);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      font-weight: 500;
    }

    .week-btn:hover {
      border-color: var(--primary-color);
      background: var(--primary-light);
    }

    .week-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    /* Data view environment */
    .data-view-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-body);
      z-index: 2000;
      padding: 20px;
      overflow: auto;
      display: none;
    }

    .data-view-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border-light);
    }

    .data-view-title {
      font-size: var(--font-size-2xl);
      color: var(--primary-color);
      font-weight: 700;
    }

    .data-view-content {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      padding: 24px;
      border: 1px solid var(--border-light);
    }
  </style>
</head>
<body>
  <!-- Theme Toggle -->
  <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
    <i class="fas fa-moon" id="theme-icon"></i>
  </button>

  <!-- Enhanced Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <i class="fas fa-seedling"></i>
      </div>
      <h2 class="sidebar-title">Sistema Plantio</h2>
      <p class="sidebar-subtitle">Gestão Inteligente</p>
    </div>

    <div class="tooltip">
      <button class="btn btn-sidebar active" onclick="mostrarDashboard()">
        <i class="fas fa-chart-dashboard"></i>
        <span>Dashboard</span>
      </button>
      <span class="tooltip-text">Visão geral dos dados e estatísticas principais</span>
    </div>

    <div class="tooltip">
      <button class="btn btn-sidebar" onclick="abrirModal('semanasModal')">
        <i class="fas fa-calendar-alt"></i>
        <span>Semanas</span>
      </button>
      <span class="tooltip-text">Selecionar e gerenciar semanas</span>
    </div>

    <div class="tooltip">
      <button class="btn btn-sidebar" onclick="abrirModal('dataModal')">
        <i class="fas fa-upload"></i>
        <span>Importar Dados</span>
      </button>
      <span class="tooltip-text">Importar dados da planilha para análise</span>
    </div>

    <div class="tooltip">
      <button class="btn btn-sidebar" onclick="abrirModalDadosPlantio()">
        <i class="fas fa-table"></i>
        <span>Dados do Plantio</span>
      </button>
      <span class="tooltip-text">Visualizar dados completos do plantio</span>
    </div>

    <div class="tooltip">
      <button class="btn btn-sidebar" onclick="abrirModalMetas()">
        <i class="fas fa-bullseye"></i>
        <span>Definir Objetivos</span>
      </button>
      <span class="tooltip-text">Configurar metas individuais por distribuidor</span>
    </div>

    <div class="tooltip">
      <button class="btn btn-sidebar" onclick="abrirModalAnalise()">
        <i class="fas fa-chart-line"></i>
        <span>Análise Comparativa</span>
      </button>
      <span class="tooltip-text">Comparar desempenho entre períodos</span>
    </div>

    <div class="tooltip">
      <button class="btn btn-sidebar" onclick="abrirModalRecordes()">
        <i class="fas fa-trophy"></i>
        <span>Recordes</span>
      </button>
      <span class="tooltip-text">Definir e acompanhar recordes pessoais</span>
    </div>

    <div class="tooltip">
      <button class="btn btn-sidebar" onclick="gerarRelatorioVisual()">
        <i class="fas fa-file-pdf"></i>
        <span>Relatório PDF</span>
      </button>
      <span class="tooltip-text">Gerar relatório visual em alta qualidade</span>
    </div>

    <div class="tooltip">
      <button class="btn btn-sidebar" onclick="gerarRelatorioSemCobranca()">
        <i class="fas fa-file-pdf"></i>
        <span>Relatório PDF 2</span>
      </button>
      <span class="tooltip-text">Gerar relatório sem valores de cobrança</span>
    </div>

    <div class="tooltip">
      <button class="btn btn-sidebar btn-warning" onclick="limparDados()">
        <i class="fas fa-trash-alt"></i>
        <span>Limpar Dados</span>
      </button>
      <span class="tooltip-text">Remover todos os dados armazenados</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Enhanced Header -->
    <div class="header">
      <div class="header-title">
        <i class="fas fa-seedling"></i>
        <h1>Acompanhamento de Plantio <span id="weekIndicator" style="font-size: 18px; color: var(--accent-color);"></span></h1>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" onclick="toggleEditMode()">
          <i class="fas fa-edit"></i>
          <span id="editModeText">Editar</span>
        </button>
        <button class="btn btn-secondary" onclick="salvarAlteracoes()" id="salvarBtn" style="display: none;">
          <i class="fas fa-save"></i>
          <span>Salvar</span>
        </button>
      </div>
    </div>

    <!-- Enhanced Statistics Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <i class="fas fa-bullseye stat-icon"></i>
        <span class="stat-value" id="totalTarget" onclick="editarStat(this)">0</span>
        <div class="stat-label">Objetivo Total</div>
        <div class="stat-change positive" id="targetChange" style="display: none;">
          <i class="fas fa-arrow-up"></i> +5.2%
        </div>
      </div>
      
      <div class="stat-card">
        <i class="fas fa-chart-line stat-icon"></i>
        <span class="stat-value" id="totalProgress" onclick="editarStat(this)">0</span>
        <div class="stat-label">Progresso Atual</div>
        <div class="stat-change positive" id="progressChange" style="display: none;">
          <i class="fas fa-arrow-up"></i> +12.8%
        </div>
      </div>
      
      <div class="stat-card">
        <i class="fas fa-clock stat-icon"></i>
        <span class="stat-value" id="pendentes">0</span>
        <div class="stat-label">Pendentes</div>
        <div class="stat-change neutral" id="pendentesChange" style="display: none;">
          <i class="fas fa-minus"></i> 0
        </div>
      </div>
      
      <div class="stat-card">
        <i class="fas fa-users stat-icon"></i>
        <span class="stat-value" id="totalDistributors">0</span>
        <div class="stat-label">Distribuidores</div>
        <div class="stat-change neutral" id="distributorsChange" style="display: none;">
          <i class="fas fa-equals"></i> Mesmo
        </div>
      </div>
    </div>

    <!-- Comparison Stats -->
    <div id="comparisonContainer" style="display: none;">
      <div class="comparison-tabs">
        <div class="comparison-tab active" onclick="selecionarComparacao('distribuicao')">vs Distribuição</div>
        <div class="comparison-tab" onclick="selecionarComparacao('anoAnterior')">vs Ano Anterior</div>
      </div>

      <div id="comparisonDistribuicao" class="comparison-content active">
        <div class="comparison-stats">
          <div class="comparison-card">
            <div class="comparison-title">
              <i class="fas fa-chart-bar"></i>
              <span>Comparativo Semanal</span>
            </div>
            <div class="comparison-value" id="comparisonNotas">0</div>
            <div class="comparison-label">Diferença de Notas (Atual vs Distribuição)</div>
            <div class="comparison-difference" id="comparisonNotasDiff"></div>
          </div>
          
          <div class="comparison-card">
            <div class="comparison-title">
              <i class="fas fa-money-bill-wave"></i>
              <span>Comparativo Financeiro</span>
            </div>
            <div class="comparison-value" id="comparisonFinanceiro">R$ 0,00</div>
            <div class="comparison-label">Diferença Financeira (Atual vs Distribuição)</div>
            <div class="comparison-difference" id="comparisonFinanceiroDiff"></div>
          </div>
          
          <div class="comparison-card">
            <div class="comparison-title">
              <i class="fas fa-percentage"></i>
              <span>Performance Geral</span>
            </div>
            <div class="comparison-value" id="comparisonPerformance">0%</div>
            <div class="comparison-label">Variação de Desempenho</div>
            <div class="comparison-difference" id="comparisonPerformanceDiff"></div>
          </div>
        </div>
      </div>

      <div id="comparisonAnoAnterior" class="comparison-content">
        <div class="comparison-stats">
          <div class="comparison-card">
            <div class="comparison-title">
              <i class="fas fa-chart-bar"></i>
              <span>Comparativo Anual</span>
            </div>
            <div class="comparison-value" id="comparisonNotasAnoAnterior">0</div>
            <div class="comparison-label">Diferença de Notas (Atual vs Ano Anterior)</div>
            <div class="comparison-difference" id="comparisonNotasAnoAnteriorDiff"></div>
          </div>
          
          <div class="comparison-card">
            <div class="comparison-title">
              <i class="fas fa-money-bill-wave"></i>
              <span>Comparativo Financeiro</span>
            </div>
            <div class="comparison-value" id="comparisonFinanceiroAnoAnterior">R$ 0,00</div>
            <div class="comparison-label">Diferença Financeira (Atual vs Ano Anterior)</div>
            <div class="comparison-difference" id="comparisonFinanceiroAnoAnteriorDiff"></div>
          </div>
          
          <div class="comparison-card">
            <div class="comparison-title">
              <i class="fas fa-percentage"></i>
              <span>Performance Geral</span>
            </div>
            <div class="comparison-value" id="comparisonPerformanceAnoAnterior">0%</div>
            <div class="comparison-label">Variação de Desempenho</div>
            <div class="comparison-difference" id="comparisonPerformanceAnoAnteriorDiff"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Data Table -->
    <div class="data-table-container">
      <div class="table-header">
        <h3 class="table-title">
          <i class="fas fa-table"></i>
          Dados de Plantio
        </h3>
        <div class="table-actions">
          <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" class="form-control" id="searchInput" placeholder="Buscar distribuidor..." oninput="filtrarTabela()">
          </div>
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th class="sortable" onclick="ordenarTabela(0)">
                <i class="fas fa-user"></i> Distribuidor
                <i class="fas fa-sort" id="sort-0"></i>
              </th>
              <th class="sortable" onclick="ordenarTabela(1)">
                <i class="fas fa-bullseye"></i> Objetivo
                <i class="fas fa-sort" id="sort-1"></i>
              </th>
              <th class="sortable" onclick="ordenarTabela(2)">
                <i class="fas fa-seedling"></i> Notas Novas
                <i class="fas fa-sort" id="sort-2"></i>
              </th>
              <th class="sortable" onclick="ordenarTabela(3)">
                <i class="fas fa-money-bill-wave"></i> Total Cobrança
                <i class="fas fa-sort" id="sort-3"></i>
              </th>
              <th class="sortable" onclick="ordenarTabela(4)">
                <i class="fas fa-percentage"></i> Cumprimento
                <i class="fas fa-sort" id="sort-4"></i>
              </th>
              <th>
                <i class="fas fa-chart-bar"></i> Progresso
              </th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Data will be populated here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Enhanced Footer Stats -->
    <div class="footer-stats">
      <div class="footer-stat">
        <i class="fas fa-bullseye"></i>
        <span>Objetivo: <strong id="footerTotal">0</strong></span>
      </div>
      <div class="footer-stat">
        <i class="fas fa-chart-line"></i>
        <span>Progresso: <strong id="footerProgress">0</strong></span>
      </div>
      <div class="footer-stat">
        <i class="fas fa-percentage"></i>
        <span>Pendente: <strong id="footerAverage">0%</strong></span>
      </div>
      <div class="footer-stat">
        <i class="fas fa-clock"></i>
        <span id="lastUpdate">Aguardando dados...</span>
      </div>
    </div>
  </div>

  <!-- Data View Environment -->
  <div id="dataView" class="data-view-container">
    <div class="data-view-header">
      <h2 class="data-view-title">
        <i class="fas fa-table"></i>
        Dados Completos do Plantio
      </h2>
      <button class="btn btn-outline" onclick="fecharVisualizacaoDados()">
        <i class="fas fa-times"></i>
        Fechar
      </button>
    </div>
    <div class="data-view-content">
      <div id="dataViewContent">
        <!-- Data view content will be populated here -->
      </div>
    </div>
  </div>

  <!-- Enhanced Modals -->
  
  <!-- Weeks Modal -->
  <div id="semanasModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-calendar-alt"></i>
          Gerenciamento de Semanas
        </h3>
        <button class="close-btn" onclick="fecharModal('semanasModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Selecione a semana atual:</label>
          <select class="form-control" id="weekSelector" onchange="selecionarSemana(this.value)">
            <option value="">Selecione uma semana</option>
            <!-- Weeks will be populated here -->
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Criar nova semana:</label>
          <div style="display: flex; gap: 12px;">
            <input type="number" class="form-control" id="novaSemana" min="1" max="52" placeholder="Número da semana (1-52)">
            <button class="btn" onclick="criarNovaSemana()">
              <i class="fas fa-plus"></i>
              Criar
            </button>
          </div>
        </div>
        
        <hr style="margin: 20px 0; border: 1px solid var(--border-light);">
        
        <h4 style="margin-bottom: 16px;">Todas as semanas:</h4>
        <div class="week-grid" id="weekGrid">
          <!-- Week buttons will be populated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('semanasModal')">
          <i class="fas fa-times"></i>
          Fechar
        </button>
      </div>
    </div>
  </div>
  
  <!-- Data Import Modal -->
  <div id="dataModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-upload"></i>
          Importar Dados
        </h3>
        <button class="close-btn" onclick="fecharModal('dataModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Tipo de Dados:</label>
          <select class="form-control" id="tiposDados" onchange="tipoDadosAtual=this.value">
            <option value="semanaAtual">Semana Atual</option>
            <option value="semanaDistribuicao">Semana de Distribuição</option>
            <option value="anoAnterior">Ano Anterior</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Cole os dados da planilha:</label>
          <textarea class="form-control" id="dataInput" rows="15" placeholder="Cole aqui os dados copiados da planilha..."></textarea>
        </div>
        <div class="form-group text-muted">
          <small>
            <i class="fas fa-info-circle"></i>
            Copie os dados diretamente da planilha e cole aqui. O sistema processará automaticamente as colunas.
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('dataModal')">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
        <button class="btn" onclick="processarDados()">
          <i class="fas fa-check"></i>
          Processar Dados
        </button>
      </div>
    </div>
  </div>

  <!-- Goals Modal -->
  <div id="metasModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-bullseye"></i>
          Definir Objetivos
        </h3>
        <button class="close-btn" onclick="fecharModal('metasModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Objetivo Geral (aplicar a todos):</label>
          <div style="display: flex; gap: 12px;">
            <input type="number" class="form-control" id="metaGeral" placeholder="Ex: 100">
            <button class="btn" onclick="aplicarMetaGeral()">
              <i class="fas fa-check"></i>
              Aplicar
            </button>
          </div>
        </div>
        <hr style="margin: 20px 0; border: 1px solid var(--border-light);">
        <div class="form-group">
          <label class="form-label">Objetivos Individuais:</label>
          <div id="metasIndividuais">
            <!-- Individual goals will be populated here -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('metasModal')">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
        <button class="btn" onclick="salvarMetas()">
          <i class="fas fa-save"></i>
          Salvar Objetivos
        </button>
      </div>
    </div>
  </div>

  <!-- Analysis Modal -->
  <div id="analiseCompletaModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-chart-line"></i>
          Análise Comparativa Completa
        </h3>
        <button class="close-btn" onclick="fecharModal('analiseCompletaModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="comparison-tabs">
          <div class="comparison-tab active" onclick="selecionarComparacaoModal('distribuicao')">vs Distribuição</div>
          <div class="comparison-tab" onclick="selecionarComparacaoModal('anoAnterior')">vs Ano Anterior</div>
        </div>

        <div id="analiseDistribuicao" class="comparison-content active">
          <!-- Analysis content will be populated here -->
        </div>

        <div id="analiseAnoAnterior" class="comparison-content">
          <!-- Analysis content will be populated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('analiseCompletaModal')">
          <i class="fas fa-times"></i>
          Fechar
        </button>
      </div>
    </div>
  </div>

  <!-- Records Modal -->
  <div id="recordesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-trophy"></i>
          Recordes Pessoais
        </h3>
        <button class="close-btn" onclick="fecharModal('recordesModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="recordesContent">
          <!-- Records content will be populated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('recordesModal')">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
        <button class="btn" onclick="salvarRecordes()">
          <i class="fas fa-save"></i>
          Salvar Recordes
        </button>
      </div>
    </div>
  </div>

  <!-- Distributor Details Modal -->
  <div id="distributorModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="distributorModalTitle">
          <i class="fas fa-user"></i>
          Dashboard do Distribuidor
        </h3>
        <button class="close-btn" onclick="fecharModal('distributorModal')">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="distributorContent">
          <!-- Distributor details will be populated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="fecharModal('distributorModal')">
          <i class="fas fa-times"></i>
          Fechar
        </button>
      </div>
    </div>
  </div>

  <script>
    // ===================================
    // GLOBAL VARIABLES & CONFIGURATION
    // ===================================
    let dadosSemanaAtual = [];
    let dadosSemanaDistribuicao = [];
    let dadosAnoAnterior = [];
    let dadosFiltrados = [];
    let metasDefinidas = {};
    let recordesDistribuidores = {};
    let historicoDistribuidores = {};
    let tipoDadosAtual = 'semanaAtual';
    let modoEdicaoManual = false;
    let currentTheme = 'light';
    let sortDirection = {};
    let performanceChart = null;
    let manualStats = {
      totalTarget: null,
      totalProgress: null
    };
    
    // New variables for week management
    let semanasData = {};
    let semanaAtual = null;

    // ===================================
    // THEME MANAGEMENT
    // ===================================
    function toggleTheme() {
      const html = document.documentElement;
      const themeIcon = document.getElementById('theme-icon');
      
      if (currentTheme === 'light') {
        html.setAttribute('data-theme', 'dark');
        themeIcon.className = 'fas fa-sun';
        currentTheme = 'dark';
      } else {
        html.setAttribute('data-theme', 'light');
        themeIcon.className = 'fas fa-moon';
        currentTheme = 'light';
      }
      
      localStorage.setItem('theme', currentTheme);
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        currentTheme = savedTheme;
        document.documentElement.setAttribute('data-theme', currentTheme);
        document.getElementById('theme-icon').className = currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      }
    }

    // ===================================
    // NOTIFICATION SYSTEM
    // ===================================
    function mostrarNotificacao(mensagem, tipo = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${tipo}`;
      
      const icon = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-circle',
        warning: 'fas fa-exclamation-triangle',
        info: 'fas fa-info-circle'
      }[tipo] || 'fas fa-info-circle';
      
      notification.innerHTML = `
        <i class="${icon}"></i>
        <span>${mensagem}</span>
      `;
      
      document.body.appendChild(notification);
      
      // Show notification
      setTimeout(() => notification.classList.add('show'), 100);
      
      // Hide and remove notification
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    // ===================================
    // MODAL MANAGEMENT
    // ===================================
    function abrirModal(modalId) {
      document.getElementById(modalId).style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function fecharModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        if (event.target === modal) {
          fecharModal(modal.id);
        }
      });
    }

    // ===================================
    // WEEK MANAGEMENT FUNCTIONS
    // ===================================
    function carregarSemanas() {
      try {
        const semanasSalvas = localStorage.getItem('semanasData');
        if (semanasSalvas) {
          semanasData = JSON.parse(semanasSalvas);
        }
        
        const semanaSelecionada = localStorage.getItem('semanaAtual');
        if (semanaSelecionada) {
          semanaAtual = semanaSelecionada;
          document.getElementById('weekIndicator').textContent = `- Semana ${semanaAtual}`;
        }
        
        atualizarSeletorSemanas();
      } catch (error) {
        console.error('Erro ao carregar semanas:', error);
        mostrarNotificacao('Erro ao carregar dados das semanas', 'error');
      }
    }
    
    function atualizarSeletorSemanas() {
      const weekSelector = document.getElementById('weekSelector');
      const weekGrid = document.getElementById('weekGrid');
      
      // Clear existing options
      weekSelector.innerHTML = '<option value="">Selecione uma semana</option>';
      weekGrid.innerHTML = '';
      
      // Get all week numbers and sort them
      const semanas = Object.keys(semanasData).map(Number).sort((a, b) => a - b);
      
      // Add options to selector
      semanas.forEach(semana => {
        const option = document.createElement('option');
        option.value = semana;
        option.textContent = `Semana ${semana}`;
        if (semanaAtual && semana == semanaAtual) {
          option.selected = true;
        }
        weekSelector.appendChild(option);
      });
      
      // Add buttons to grid
      for (let i = 1; i <= 52; i++) {
        const button = document.createElement('button');
        button.className = `week-btn ${semanasData[i] ? 'has-data' : ''} ${semanaAtual && i == semanaAtual ? 'active' : ''}`;
        button.textContent = i;
        button.onclick = () => selecionarSemana(i);
        weekGrid.appendChild(button);
      }
    }
    
    function selecionarSemana(numeroSemana) {
      if (!numeroSemana) return;
      
      semanaAtual = numeroSemana;
      localStorage.setItem('semanaAtual', semanaAtual);
      document.getElementById('weekIndicator').textContent = `- Semana ${semanaAtual}`;
      
      // Load data for selected week
      if (semanasData[semanaAtual]) {
        const semanaDados = semanasData[semanaAtual];
        dadosSemanaAtual = semanaDados.dadosSemanaAtual || [];
        dadosSemanaDistribuicao = semanaDados.dadosSemanaDistribuicao || [];
        dadosAnoAnterior = semanaDados.dadosAnoAnterior || [];
        metasDefinidas = semanaDados.metasDefinidas || {};
        recordesDistribuidores = semanaDados.recordesDistribuidores || {};
        historicoDistribuidores = semanaDados.historicoDistribuidores || {};
        manualStats = semanaDados.manualStats || {
          totalTarget: null,
          totalProgress: null
        };
      } else {
        // Initialize empty data for new week
        dadosSemanaAtual = [];
        dadosSemanaDistribuicao = [];
        dadosAnoAnterior = [];
        metasDefinidas = {};
        recordesDistribuidores = {};
        historicoDistribuidores = {};
        manualStats = {
          totalTarget: null,
          totalProgress: null
        };
      }
      
      dadosFiltrados = [...dadosSemanaAtual];
      atualizarInterface();
      atualizarComparativos();
      
      if (dadosFiltrados.length > 0) {
        updateChart();
      }
      
      atualizarSeletorSemanas();
      fecharModal('semanasModal');
      
      mostrarNotificacao(`Semana ${semanaAtual} selecionada`, 'success');
    }
    
    function criarNovaSemana() {
      const novaSemanaInput = document.getElementById('novaSemana');
      const numeroSemana = parseInt(novaSemanaInput.value);
      
      if (isNaN(numeroSemana) || numeroSemana < 1 || numeroSemana > 52) {
        mostrarNotificacao('Por favor, insira um número de semana válido (1-52)', 'warning');
        return;
      }
      
      if (semanasData[numeroSemana]) {
        mostrarNotificacao(`A semana ${numeroSemana} já existe`, 'info');
        selecionarSemana(numeroSemana);
        return;
      }
      
      // Create empty week data
      semanasData[numeroSemana] = {
        dadosSemanaAtual: [],
        dadosSemanaDistribuicao: [],
        dadosAnoAnterior: [],
        metasDefinidas: {},
        recordesDistribuidores: {},
        historicoDistribuidores: {},
        manualStats: {
          totalTarget: null,
          totalProgress: null
        }
      };
      
      salvarSemanas();
      selecionarSemana(numeroSemana);
      novaSemanaInput.value = '';
      
      mostrarNotificacao(`Semana ${numeroSemana} criada com sucesso`, 'success');
    }
    
    function salvarSemanas() {
      try {
        if (semanaAtual) {
          // Save current data to the selected week
          semanasData[semanaAtual] = {
            dadosSemanaAtual,
            dadosSemanaDistribuicao,
            dadosAnoAnterior,
            metasDefinidas,
            recordesDistribuidores,
            historicoDistribuidores,
            manualStats
          };
        }
        
        localStorage.setItem('semanasData', JSON.stringify(semanasData));
      } catch (error) {
        console.error('Erro ao salvar semanas:', error);
        mostrarNotificacao('Erro ao salvar dados das semanas', 'error');
      }
    }

    // ===================================
    // DATA VIEW FUNCTIONS
    // ===================================
    function abrirModalDadosPlantio() {
      if (dadosSemanaAtual.length === 0) {
        mostrarNotificacao('Não há dados para visualizar', 'warning');
        return;
      }
      
      const container = document.getElementById('dataViewContent');
      container.innerHTML = '';
      
      // Create enhanced table for data view
      const table = document.createElement('table');
      table.className = 'data-table';
      table.style.fontSize = '14px';
      
      // Table header
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>Distribuidor</th>
          <th>Objetivo</th>
          <th>Notas Novas</th>
          <th>Acertadas</th>
          <th>Total Cobrança</th>
          <th>% Cumprimento</th>
        </tr>
      `;
      table.appendChild(thead);
      
      // Table body
      const tbody = document.createElement('tbody');
      
      dadosSemanaAtual.forEach(item => {
        const percentual = (item.percentualCumprimento || 0).toFixed(1);
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td><strong>${item.distribuidor}</strong></td>
          <td>${item.meta || 0}</td>
          <td>${item.notasNovas || 0}</td>
          <td>${item.acertadas || 0}</td>
          <td class="text-success"><strong>${formatarMoeda(item.totalCobranca || 0)}</strong></td>
          <td><strong class="text-${getPerformanceClass(percentual)}">${percentual}%</strong></td>
        `;
        
        tbody.appendChild(tr);
      });
      
      table.appendChild(tbody);
      container.appendChild(table);
      
      // Show data view
      document.getElementById('dataView').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    
    function fecharVisualizacaoDados() {
      document.getElementById('dataView').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // ===================================
    // DATA PROCESSING FUNCTIONS
    // ===================================
    function processarDados() {
      const dadosTexto = document.getElementById('dataInput').value.trim();
      if (!dadosTexto) {
        mostrarNotificacao('Por favor, cole os dados da planilha.', 'warning');
        return;
      }

      try {
        const novosDados = [];
        const linhas = dadosTexto.split('\n');
        
        linhas.forEach((linha, index) => {
          const colunas = linha.split('\t');
          if (colunas.length < 10) return; // Skip invalid lines
          
          const distribuidor = colunas[1]?.trim();
          if (!distribuidor) return;
          
          if (tipoDadosAtual === 'semanaAtual') {
            const notasNovas = parseInt(colunas[9]) || 0;
            const acertadas = parseInt(colunas[7]) || 0;
            const totalCobranca = converterMoedaParaNumero(colunas[13]);
            const meta = metasDefinidas[distribuidor] || 0;
            
            // Update history
            if (!historicoDistribuidores[distribuidor]) {
              historicoDistribuidores[distribuidor] = [];
            }
            
            const dataAtual = new Date().toISOString().split('T')[0];
            const jaExiste = historicoDistribuidores[distribuidor].find(entry => entry.data === dataAtual);
            
            if (!jaExiste) {
              historicoDistribuidores[distribuidor].unshift({
                data: dataAtual,
                notasNovas: notasNovas,
                acertadas: acertadas,
                totalCobranca: totalCobranca,
                meta: meta
              });
              
              // Keep only last 5 entries
              if (historicoDistribuidores[distribuidor].length > 5) {
                historicoDistribuidores[distribuidor].pop();
              }
            }
            
            novosDados.push({
              distribuidor: distribuidor,
              notasNovas: notasNovas,
              acertadas: acertadas,
              totalCobranca: totalCobranca,
              meta: meta,
              percentualCumprimento: meta > 0 ? (notasNovas / meta) * 100 : 0
            });
          } else if (tipoDadosAtual === 'semanaDistribuicao') {
            const novas = parseInt(colunas[4]) || 0;
            const geral = converterMoedaParaNumero(colunas[12]);
            
            novosDados.push({
              distribuidor: distribuidor,
              novas: novas,
              geral: geral
            });
          } else if (tipoDadosAtual === 'anoAnterior') {
            const novas = parseInt(colunas[4]) || 0;
            const geral = converterMoedaParaNumero(colunas[12]);
            
            novosDados.push({
              distribuidor: distribuidor,
              novas: novas,
              geral: geral
            });
          }
        });
        
        if (tipoDadosAtual === 'semanaAtual') {
          dadosSemanaAtual = novosDados;
          dadosFiltrados = [...dadosSemanaAtual];
        } else if (tipoDadosAtual === 'semanaDistribuicao') {
          dadosSemanaDistribuicao = novosDados;
        } else if (tipoDadosAtual === 'anoAnterior') {
          dadosAnoAnterior = novosDados;
        }
        
        salvarDadosLocais();
        salvarHistoricoLocais();
        fecharModal('dataModal');
        atualizarInterface();
        updateChart();
        atualizarComparativos();
        
        mostrarNotificacao(`${novosDados.length} registros processados com sucesso!`, 'success');
        
        // Clear input
        document.getElementById('dataInput').value = '';
        
      } catch (error) {
        console.error('Erro ao processar dados:', error);
        mostrarNotificacao('Erro ao processar dados: ' + error.message, 'error');
      }
    }

    // ===================================
    // CURRENCY CONVERSION FUNCTIONS
    // ===================================
    function converterMoedaParaNumero(valor) {
      if (!valor) return 0;
      if (typeof valor === 'number') return valor;
      
      return parseFloat(
        valor.toString()
          .replace(/[R$\s]/g, '')
          .replace(/\./g, '')
          .replace(',', '.')
      ) || 0;
    }

    function formatarMoeda(valor) {
      if (!valor && valor !== 0) return 'R$ 0,00';
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(valor);
    }

    function formatarMoedaSemPrefixo(valor) {
      if (!valor && valor !== 0) return '0,00';
      return new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(valor);
    }

    function formatarDiferencaMoeda(valor) {
      const sinal = valor >= 0 ? '+' : '';
      return sinal + formatarMoeda(Math.abs(valor));
    }

    // ===================================
    // DATA STORAGE FUNCTIONS
    // ===================================
    function salvarDadosLocais() {
      try {
        // Save to current week
        if (semanaAtual) {
          semanasData[semanaAtual] = {
            dadosSemanaAtual,
            dadosSemanaDistribuicao,
            dadosAnoAnterior,
            metasDefinidas,
            recordesDistribuidores,
            historicoDistribuidores,
            manualStats
          };
          localStorage.setItem('semanasData', JSON.stringify(semanasData));
        }
        
        localStorage.setItem('ultimaAtualizacao', new Date().toISOString());
      } catch (error) {
        console.error('Erro ao salvar dados:', error);
        mostrarNotificacao('Erro ao salvar dados localmente', 'error');
      }
    }

    function salvarHistoricoLocais() {
      try {
        // No need to save separately as it's included in semanasData
      } catch (error) {
        console.error('Erro ao salvar histórico:', error);
      }
    }

    function carregarDadosLocais() {
      try {
        // Load weeks data
        carregarSemanas();
        
        // If there's a selected week, load its data
        if (semanaAtual && semanasData[semanaAtual]) {
          const semanaDados = semanasData[semanaAtual];
          dadosSemanaAtual = semanaDados.dadosSemanaAtual || [];
          dadosSemanaDistribuicao = semanaDados.dadosSemanaDistribuicao || [];
          dadosAnoAnterior = semanaDados.dadosAnoAnterior || [];
          metasDefinidas = semanaDados.metasDefinidas || {};
          recordesDistribuidores = semanaDados.recordesDistribuidores || {};
          historicoDistribuidores = semanaDados.historicoDistribuidores || {};
          manualStats = semanaDados.manualStats || {
            totalTarget: null,
            totalProgress: null
          };
        }
        
        dadosFiltrados = [...dadosSemanaAtual];
        atualizarUltimaModificacao();
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        mostrarNotificacao('Erro ao carregar dados salvos', 'error');
      }
    }

    // ===================================
    // EDIT STATS FUNCTIONS
    // ===================================
    function editarStat(element) {
      if (!modoEdicaoManual) return;
      
      const statId = element.id;
      const currentValue = element.textContent.replace(/\D/g, '');
      
      // Create input field
      const input = document.createElement('input');
      input.type = 'number';
      input.className = 'stat-value-input';
      input.value = currentValue;
      
      // Replace span with input
      element.parentNode.replaceChild(input, element);
      input.focus();
      
      // Save on enter or blur
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          salvarStatEdit(input, statId);
        }
      });
      
      input.addEventListener('blur', function() {
        salvarStatEdit(input, statId);
      });
    }
    
    function salvarStatEdit(input, statId) {
      const newValue = parseInt(input.value) || 0;
      
      // Save manual value
      manualStats[statId] = newValue;
      salvarDadosLocais();
      
      // Create new span
      const span = document.createElement('span');
      span.className = 'stat-value' + (modoEdicaoManual ? ' editable' : '');
      span.id = statId;
      span.textContent = newValue.toLocaleString('pt-BR');
      
      if (modoEdicaoManual) {
        span.onclick = function() { editarStat(this); };
      }
      
      // Replace input with span
      input.parentNode.replaceChild(span, input);
      
      // Update footer if needed
      if (statId === 'totalTarget') {
        document.getElementById('footerTotal').textContent = newValue.toLocaleString('pt-BR');
      } else if (statId === 'totalProgress') {
        document.getElementById('footerProgress').textContent = newValue.toLocaleString('pt-BR');
      }
      
      mostrarNotificacao(`Valor de ${statId} atualizado para ${newValue}`, 'success');
    }

    // ===================================
    // INTERFACE UPDATE FUNCTIONS
    // ===================================
    function atualizarInterface() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      
      let totalMetaCalculada = 0;
      let totalNotasCalculadas = 0;
      let totalPercentual = 0;
      
      // Sort data by percentage
      const dadosOrdenados = [...dadosFiltrados].sort((a, b) => {
        return (b.percentualCumprimento || 0) - (a.percentualCumprimento || 0);
      });
      
      dadosOrdenados.forEach((item, index) => {
        const percentual = (item.percentualCumprimento || 0).toFixed(1);
        totalMetaCalculada += item.meta || 0;
        totalNotasCalculadas += item.notasNovas || 0;
        totalPercentual += parseFloat(percentual);
        
        const tr = document.createElement('tr');
        tr.className = index < 3 ? 'top-performer' : '';
        
        // Check if distributor broke their record
        const recordeAtual = recordesDistribuidores[item.distribuidor] || 0;
        const bateuRecorde = item.totalCobranca > recordeAtual;
        
        if (bateuRecorde && recordeAtual > 0) {
          recordesDistribuidores[item.distribuidor] = item.totalCobranca;
          salvarDadosLocais();
        }
        
        if (modoEdicaoManual) {
          // Edit mode - editable fields
          tr.innerHTML = `
            <td>
              <span class="nome-clicavel" onclick="exibirDetalhes('${item.distribuidor.replace(/'/g, "&apos;")}" title="Clique para ver detalhes">
                ${item.distribuidor}
              </span>
            </td>
            <td><input type="number" class="form-control editable-field" value="${item.meta || 0}" data-field="meta" data-distribuidor="${item.distribuidor}"></td>
            <td><input type="number" class="form-control editable-field" value="${item.notasNovas || 0}" data-field="notasNovas" data-distribuidor="${item.distribuidor}"></td>
            <td><input type="text" class="form-control editable-field currency-input" value="${formatarMoedaSemPrefixo(item.totalCobranca || 0)}" data-field="totalCobranca" data-distribuidor="${item.distribuidor}"></td>
            <td><strong class="text-${getPerformanceClass(percentual)}">${percentual}%</strong></td>
            <td>
              <div class="progress-container">
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${Math.min(100, percentual)}%"></div>
                  <div class="progress-text">${percentual}%</div>
                </div>
              </div>
            </td>
          `;
        } else {
          // View mode - read-only
          tr.innerHTML = `
            <td>
              <span class="nome-clicavel" onclick="exibirDetalhes('${item.distribuidor.replace(/'/g, "&apos;")}')" title="Clique para ver detalhes">
                <i class="fas fa-user"></i>
                ${item.distribuidor}
                ${bateuRecorde && recordeAtual > 0 ? '<span class="record-badge" title="Novo recorde pessoal!">RECORDE</span>' : ''}
              </span>
            </td>
            <td><strong>${item.meta || 0}</strong></td>
            <td><strong>${item.notasNovas || 0}</strong></td>
            <td class="text-success"><strong>${formatarMoeda(item.totalCobranca || 0)}</strong></td>
            <td><strong class="text-${getPerformanceClass(percentual)}">${percentual}%</strong></td>
            <td>
              <div class="progress-container">
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${Math.min(100, percentual)}%"></div>
                  <div class="progress-text">${percentual}%</div>
                </div>
              </div>
            </td>
          `;
        }
        
        tbody.appendChild(tr);
      });
      
      // Apply currency mask to editable fields
      if (modoEdicaoManual) {
        document.querySelectorAll('.currency-input').forEach(input => {
          aplicarMascaraMoedaInput(input);
        });
      }
      
      // Update statistics
      const media = dadosFiltrados.length ? (totalPercentual / dadosFiltrados.length).toFixed(1) : 0;
      
      // Use manual values if they exist, otherwise calculate from data
      const totalMeta = manualStats.totalTarget !== null ? manualStats.totalTarget : totalMetaCalculada;
      const totalNotas = manualStats.totalProgress !== null ? manualStats.totalProgress : totalNotasCalculadas;
      
      // Update stats display
      const totalTargetElement = document.getElementById('totalTarget');
      const totalProgressElement = document.getElementById('totalProgress');
      
      totalTargetElement.textContent = totalMeta.toLocaleString('pt-BR');
      totalProgressElement.textContent = totalNotas.toLocaleString('pt-BR');
      const pendentes = Math.max(0, totalMeta - totalNotas);
      document.getElementById('pendentes').textContent = pendentes.toLocaleString('pt-BR');
      document.getElementById('totalDistributors').textContent = dadosFiltrados.length;
      
      // Add editable class in edit mode
      if (modoEdicaoManual) {
        totalTargetElement.classList.add('editable');
        totalProgressElement.classList.add('editable');
        totalTargetElement.onclick = function() { editarStat(this); };
        totalProgressElement.onclick = function() { editarStat(this); };
      } else {
        totalTargetElement.classList.remove('editable');
        totalProgressElement.classList.remove('editable');
        totalTargetElement.onclick = null;
        totalProgressElement.onclick = null;
      }
      
      // Update footer
      document.getElementById('footerTotal').textContent = totalMeta.toLocaleString('pt-BR');
      document.getElementById('footerProgress').textContent = totalNotas.toLocaleString('pt-BR');
      document.getElementById('footerAverage').textContent = pendentes.toLocaleString('pt-BR');
    }

    function atualizarComparativos() {
      if (dadosSemanaAtual.length === 0) {
        document.getElementById('comparisonContainer').style.display = 'none';
        return;
      }
      
      document.getElementById('comparisonContainer').style.display = 'block';
      
      // Calculate totals for distribution comparison
      const totalAtualNotas = dadosSemanaAtual.reduce((sum, item) => sum + (item.notasNovas || 0), 0);
      const totalDistNotas = dadosSemanaDistribuicao.reduce((sum, item) => sum + (item.novas || 0), 0);
      const diffNotas = totalAtualNotas - totalDistNotas;
      
      const totalAtualCobranca = dadosSemanaAtual.reduce((sum, item) => sum + (item.totalCobranca || 0), 0);
      const totalDistCobranca = dadosSemanaDistribuicao.reduce((sum, item) => sum + (item.geral || 0), 0);
      const diffCobranca = totalAtualCobranca - totalDistCobranca;
      
      const variacaoNotas = totalDistNotas > 0 ? ((diffNotas / totalDistNotas) * 100).toFixed(1) : 0;
      
      // Update distribution comparison elements
      document.getElementById('comparisonNotas').textContent = diffNotas >= 0 ? `+${diffNotas}` : diffNotas;
      document.getElementById('comparisonFinanceiro').textContent = formatarDiferencaMoeta(diffCobranca);
      document.getElementById('comparisonPerformance').textContent = `${variacaoNotas >= 0 ? '+' : ''}${variacaoNotas}%`;
      
      document.getElementById('comparisonNotasDiff').innerHTML = `
        <span class="${diffNotas >= 0 ? 'positive-diff' : 'negative-diff'}">
          <i class="fas fa-arrow-${diffNotas >= 0 ? 'up' : 'down'}"></i>
          ${Math.abs(diffNotas)} notas (${Math.abs(variacaoNotas)}%)
        </span>
      `;
      
      document.getElementById('comparisonFinanceiroDiff').innerHTML = `
        <span class="${diffCobranca >= 0 ? 'positive-diff' : 'negative-diff'}">
          <i class="fas fa-arrow-${diffCobranca >= 0 ? 'up' : 'down'}"></i>
          ${formatarMoeda(Math.abs(diffCobranca))}
        </span>
      `;
      
      document.getElementById('comparisonPerformanceDiff').innerHTML = `
        <span class="${variacaoNotas >= 0 ? 'positive-diff' : 'negative-diff'}">
          <i class="fas fa-arrow-${variacaoNotas >= 0 ? 'up' : 'down'}"></i>
          ${Math.abs(variacaoNotas)}%
        </span>
      `;
      
      // Calculate totals for year comparison if data exists
      if (dadosAnoAnterior.length > 0) {
        const totalAnoAnteriorNotas = dadosAnoAnterior.reduce((sum, item) => sum + (item.novas || 0), 0);
        const diffNotasAnoAnterior = totalAtualNotas - totalAnoAnteriorNotas;
        const variacaoNotasAnoAnterior = totalAnoAnteriorNotas > 0 ? ((diffNotasAnoAnterior / totalAnoAnteriorNotas) * 100).toFixed(1) : 0;
        
        const totalAnoAnteriorCobranca = dadosAnoAnterior.reduce((sum, item) => sum + (item.geral || 0), 0);
        const diffCobrancaAnoAnterior = totalAtualCobranca - totalAnoAnteriorCobranca;
        
        // Update year comparison elements
        document.getElementById('comparisonNotasAnoAnterior').textContent = diffNotasAnoAnterior >= 0 ? `+${diffNotasAnoAnterior}` : diffNotasAnoAnterior;
        document.getElementById('comparisonFinanceiroAnoAnterior').textContent = formatarDiferencaMoeda(diffCobrancaAnoAnterior);
        document.getElementById('comparisonPerformanceAnoAnterior').textContent = `${variacaoNotasAnoAnterior >= 0 ? '+' : ''}${variacaoNotasAnoAnterior}%`;
        
        document.getElementById('comparisonNotasAnoAnteriorDiff').innerHTML = `
          <span class="${diffNotasAnoAnterior >= 0 ? 'positive-diff' : 'negative-diff'}">
            <i class="fas fa-arrow-${diffNotasAnoAnterior >= 0 ? 'up' : 'down'}"></i>
            ${Math.abs(diffNotasAnoAnterior)} notas (${Math.abs(variacaoNotasAnoAnterior)}%)
          </span>
        `;
        
        document.getElementById('comparisonFinanceiroAnoAnteriorDiff').innerHTML = `
          <span class="${diffCobrancaAnoAnterior >= 0 ? 'positive-diff' : 'negative-diff'}">
            <i class="fas fa-arrow-${diffCobrancaAnoAnterior >= 0 ? 'up' : 'down'}"></i>
            ${formatarMoeda(Math.abs(diffCobrancaAnoAnterior))}
          </span>
        `;
        
        document.getElementById('comparisonPerformanceAnoAnteriorDiff').innerHTML = `
          <span class="${variacaoNotasAnoAnterior >= 0 ? 'positive-diff' : 'negative-diff'}">
            <i class="fas fa-arrow-${variacaoNotasAnoAnterior >= 0 ? 'up' : 'down'}"></i>
            ${Math.abs(variacaoNotasAnoAnterior)}%
          </span>
        `;
      }
    }

    function selecionarComparacao(tipo) {
      document.querySelectorAll('.comparison-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('.comparison-content').forEach(content => {
        content.classList.remove('active');
      });
      
      event.target.classList.add('active');
      
      if (tipo === 'distribuicao') {
        document.getElementById('comparisonDistribuicao').classList.add('active');
      } else if (tipo === 'anoAnterior') {
        document.getElementById('comparisonAnoAnterior').classList.add('active');
      }
    }

    function selecionarComparacaoModal(tipo) {
      document.querySelectorAll('#analiseCompletaModal .comparison-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('#analiseCompletaModal .comparison-content').forEach(content => {
        content.classList.remove('active');
      });
      
      event.target.classList.add('active');
      
      if (tipo === 'distribuicao') {
        document.getElementById('analiseDistribuicao').classList.add('active');
      } else if (tipo === 'anoAnterior') {
        document.getElementById('analiseAnoAnterior').classList.add('active');
      }
    }

    function getPerformanceClass(percentage) {
      const perc = parseFloat(percentage);
      if (perc >= 100) return 'success';
      if (perc >= 80) return 'warning';
      return 'danger';
    }

    function getColorForPercentage(percentage) {
      const perc = parseFloat(percentage);
      if (perc >= 100) return '#4CAF50';
      if (perc >= 80) return '#FF9800';
      return '#f44336';
    }

    // ===================================
    // CHART FUNCTIONS
    // ===================================
    function updateChart() {
      const ctx = document.getElementById('performanceChart');
      if (!ctx || dadosFiltrados.length === 0) return;
      
      // Destroy existing chart
      if (performanceChart) {
        performanceChart.destroy();
      }
      
      // Prepare data
      const sortedData = [...dadosFiltrados]
        .sort((a, b) => (b.percentualCumprimento || 0) - (a.percentualCumprimento || 0))
        .slice(0, 10); // Show top 10
      
      const labels = sortedData.map(item => item.distribuidor);
      const data = sortedData.map(item => item.percentualCumprimento || 0);
      const colors = data.map(value => getColorForPercentage(value));
      
      performanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Percentual de Cumprimento (%)',
            data: data,
            backgroundColor: colors,
            borderColor: colors,
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              cornerRadius: 8,
              callbacks: {
                label: function(context) {
                  return `${context.parsed.y.toFixed(1)}%`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: Math.max(100, Math.max(...data) + 10),
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 0
              },
              grid: {
                display: false
              }
            }
          },
          animation: {
            duration: 1000,
            easing: 'easeOutCubic'
          }
        }
      });
    }

    // ===================================
    // EDIT MODE FUNCTIONS
    // ===================================
    function toggleEditMode() {
      modoEdicaoManual = !modoEdicaoManual;
      const editModeText = document.getElementById('editModeText');
      const salvarBtn = document.getElementById('salvarBtn');
      
      if (modoEdicaoManual) {
        editModeText.textContent = 'Visualizar';
        salvarBtn.style.display = 'inline-flex';
        mostrarNotificacao('Modo de edição ativado', 'info');
      } else {
        editModeText.textContent = 'Editar';
        salvarBtn.style.display = 'none';
        mostrarNotificacao('Modo de visualização ativado', 'info');
      }
      
      atualizarInterface();
    }

    function salvarAlteracoes() {
      try {
        const campos = document.querySelectorAll('.editable-field');
        let alteracoes = 0;
        
        campos.forEach(campo => {
          const distribuidor = campo.dataset.distribuidor;
          const field = campo.dataset.field;
          let valor = campo.value;
          
          // Find the item in data
          const item = dadosSemanaAtual.find(d => d.distribuidor === distribuidor);
          if (!item) return;
          
          // Convert value based on field type
          if (field === 'totalCobranca') {
            valor = converterMoedaParaNumero(valor);
          } else {
            valor = parseInt(valor) || 0;
          }
          
          // Update if changed
          if (item[field] !== valor) {
            item[field] = valor;
            alteracoes++;
          }
          
          // Recalculate percentage for meta changes
          if (field === 'meta' || field === 'notasNovas') {
            item.percentualCumprimento = item.meta > 0 ? (item.notasNovas / item.meta) * 100 : 0;
            metasDefinidas[distribuidor] = item.meta;
          }
        });
        
        if (alteracoes > 0) {
          salvarDadosLocais();
          dadosFiltrados = [...dadosSemanaAtual];
          atualizarInterface();
          updateChart();
          mostrarNotificacao(`${alteracoes} alterações salvas com sucesso!`, 'success');
        } else {
          mostrarNotificacao('Nenhuma alteração foi detectada', 'info');
        }
        
      } catch (error) {
        console.error('Erro ao salvar alterações:', error);
        mostrarNotificacao('Erro ao salvar alterações', 'error');
      }
    }

    // ===================================
    // GOALS MANAGEMENT
    // ===================================
    function abrirModalMetas() {
      if (dadosSemanaAtual.length === 0) {
        mostrarNotificacao('Carregue os dados primeiro para definir metas', 'warning');
        return;
      }
      
      const container = document.getElementById('metasIndividuais');
      container.innerHTML = '';
      
      dadosSemanaAtual.forEach(item => {
        const metaAtual = metasDefinidas[item.distribuidor] || item.meta || 0;
        
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
          <label class="form-label">${item.distribuidor}:</label>
          <input type="number" class="form-control meta-individual" 
                 value="${metaAtual}" 
                 data-distribuidor="${item.distribuidor}"
                 placeholder="Meta individual">
        `;
        container.appendChild(div);
      });
      
      abrirModal('metasModal');
    }

    function aplicarMetaGeral() {
      const metaGeral = parseInt(document.getElementById('metaGeral').value) || 0;
      
      if (metaGeral <= 0) {
        mostrarNotificacao('Por favor, insira uma meta válida', 'warning');
        return;
      }
      
      // Apply to all individual fields
      document.querySelectorAll('.meta-individual').forEach(input => {
        input.value = metaGeral;
      });
      
      mostrarNotificacao(`Meta de ${metaGeral} aplicada a todos os distribuidores`, 'success');
    }

    function salvarMetas() {
      try {
        let metasSalvas = 0;
        
        document.querySelectorAll('.meta-individual').forEach(input => {
          const distribuidor = input.dataset.distribuidor;
          const meta = parseInt(input.value) || 0;
          
          if (meta !== metasDefinidas[distribuidor]) {
            metasDefinidas[distribuidor] = meta;
            
            // Update in current data
            const item = dadosSemanaAtual.find(d => d.distribuidor === distribuidor);
            if (item) {
              item.meta = meta;
              item.percentualCumprimento = meta > 0 ? (item.notasNovas / meta) * 100 : 0;
            }
            
            metasSalvas++;
          }
        });
        
        if (metasSalvas > 0) {
          dadosFiltrados = [...dadosSemanaAtual];
          salvarDadosLocais();
          fecharModal('metasModal');
          atualizarInterface();
          updateChart();
          mostrarNotificacao(`${metasSalvas} metas atualizadas com sucesso!`, 'success');
        } else {
          mostrarNotificacao('Nenhuma alteração foi detectada', 'info');
        }
        
      } catch (error) {
        console.error('Erro ao salvar metas:', error);
        mostrarNotificacao('Erro ao salvar metas', 'error');
      }
    }

    // ===================================
    // RECORDS MANAGEMENT
    // ===================================
    function abrirModalRecordes() {
      if (dadosSemanaAtual.length === 0) {
        mostrarNotificacao('Carregue os dados primeiro para definir recordes', 'warning');
        return;
      }
      
      const container = document.getElementById('recordesContent');
      container.innerHTML = '';
      
      dadosSemanaAtual.forEach(item => {
        const recordeAtual = recordesDistribuidores[item.distribuidor] || 0;
        
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
          <label class="form-label">
            <i class="fas fa-trophy text-warning"></i>
            ${item.distribuidor}:
          </label>
          <input type="text" class="form-control recorde-individual currency-input" 
                 value="${formatarMoedaSemPrefixo(recordeAtual)}" 
                 data-distribuidor="${item.distribuidor}"
                 placeholder="Recorde pessoal">
        `;
        container.appendChild(div);
      });
      
      // Apply currency mask
      document.querySelectorAll('.recorde-individual').forEach(input => {
        aplicarMascaraMoedaInput(input);
      });
      
      abrirModal('recordesModal');
    }

    function salvarRecordes() {
      try {
        let recordesSalvos = 0;
        
        document.querySelectorAll('.recorde-individual').forEach(input => {
          const distribuidor = input.dataset.distribuidor;
          const recorde = converterMoedaParaNumero(input.value);
          
          if (recorde !== recordesDistribuidores[distribuidor]) {
            recordesDistribuidores[distribuidor] = recorde;
            recordesSalvos++;
          }
        });
        
        if (recordesSalvos > 0) {
          salvarDadosLocais();
          fecharModal('recordesModal');
          mostrarNotificacao(`${recordesSalvos} recordes atualizados com sucesso!`, 'success');
        } else {
          mostrarNotificacao('Nenhuma alteração foi detectada', 'info');
        }
        
      } catch (error) {
        console.error('Erro ao salvar recordes:', error);
        mostrarNotificacao('Erro ao salvar recordes', 'error');
      }
    }

    // ===================================
    // ANALYSIS FUNCTIONS
    // ===================================
    function abrirModalAnalise() {
      if (dadosSemanaAtual.length === 0) {
        mostrarNotificacao('Carregue os dados primeiro para análise comparativa', 'warning');
        return;
      }

      const containerDistribuicao = document.getElementById('analiseDistribuicao');
      containerDistribuicao.innerHTML = '';
      
      const containerAnoAnterior = document.getElementById('analiseAnoAnterior');
      containerAnoAnterior.innerHTML = '';
      
      // Create comparison table for distribution
      if (dadosSemanaDistribuicao.length > 0) {
        const tableDistribuicao = document.createElement('table');
        tableDistribuicao.className = 'data-table';
        tableDistribuicao.innerHTML = `
          <thead>
            <tr>
              <th><i class="fas fa-user"></i> Distribuidor</th>
              <th><i class="fas fa-calendar-week"></i> Semana Atual</th>
              <th><i class="fas fa-share-alt"></i> Distribuição</th>
              <th><i class="fas fa-chart-line"></i> Diferença</th>
              <th><i class="fas fa-percentage"></i> Variação</th>
            </tr>
          </thead>
        `;
        
        const tbodyDistribuicao = document.createElement('tbody');
        
        dadosSemanaAtual.forEach(itemAtual => {
          const itemDist = dadosSemanaDistribuicao.find(d => d.distribuidor === itemAtual.distribuidor);
          if (!itemDist) return;
          
          const diferenca = (itemAtual.notasNovas || 0) - (itemDist.novas || 0);
          const variacao = itemDist.novas > 0 ? ((diferenca / itemDist.novas) * 100).toFixed(1) : 0;
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${itemAtual.distribuidor}</strong></td>
            <td>${itemAtual.notasNovas || 0}</td>
            <td>${itemDist.novas || 0}</td>
            <td class="text-${diferenca >= 0 ? 'success' : 'danger'}">
              <strong>${diferenca >= 0 ? '+' : ''}${diferenca}</strong>
            </td>
            <td class="text-${parseFloat(variacao) >= 0 ? 'success' : 'danger'}">
              <strong>${variacao >= 0 ? '+' : ''}${variacao}%</strong>
            </td>
          `;
          tbodyDistribuicao.appendChild(tr);
        });
        
        tableDistribuicao.appendChild(tbodyDistribuicao);
        
        // Add summary section for distribution
        const totalAtualNotas = dadosSemanaAtual.reduce((sum, item) => sum + (item.notasNovas || 0), 0);
        const totalDistNotas = dadosSemanaDistribuicao.reduce((sum, item) => sum + (item.novas || 0), 0);
        const diffNotas = totalAtualNotas - totalDistNotas;
        const variacaoNotas = totalDistNotas > 0 ? ((diffNotas / totalDistNotas) * 100).toFixed(1) : 0;
        
        const totalAtualCobranca = dadosSemanaAtual.reduce((sum, item) => sum + (item.totalCobranca || 0), 0);
        const totalDistCobranca = dadosSemanaDistribuicao.reduce((sum, item) => sum + (item.geral || 0), 0);
        const diffCobranca = totalAtualCobranca - totalDistCobranca;
        
        const summaryDivDistribuicao = document.createElement('div');
        summaryDivDistribuicao.className = 'chart-container';
        summaryDivDistribuicao.innerHTML = `
          <h4 class="chart-title">
            <i class="fas fa-chart-pie"></i>
            Resumo Comparativo - Semana de Distribuição
          </h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div style="background: var(--bg-card); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-sm);">
              <div style="font-size: var(--font-size-lg); color: var(--text-light); margin-bottom: 10px;">Notas Novas</div>
              <div style="font-size: var(--font-size-2xl); font-weight: bold; margin-bottom: 5px;">${totalAtualNotas} <span style="font-size: var(--font-size-lg); color: var(--text-light);">(Atual)</span></div>
              <div style="font-size: var(--font-size-xl); color: var(--text-light); margin-bottom: 10px;">${totalDistNotas} <span style="font-size: var(--font-size-sm);">(Distribuição)</span></div>
              <div style="font-size: var(--font-size-lg); color: ${diffNotas >= 0 ? 'var(--success-color)' : 'var(--danger-color)'}">
                <i class="fas fa-arrow-${diffNotas >= 0 ? 'up' : 'down'}"></i>
                ${diffNotas >= 0 ? '+' : ''}${diffNotas} (${variacaoNotas >= 0 ? '+' : ''}${variacaoNotas}%)
              </div>
            </div>
            
            <div style="background: var(--bg-card); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-sm);">
              <div style="font-size: var(--font-size-lg); color: var(--text-light); margin-bottom: 10px;">Total Cobrança</div>
              <div style="font-size: var(--font-size-2xl); font-weight: bold; margin-bottom: 5px;">${formatarMoeda(totalAtualCobranca)} <span style="font-size: var(--font-size-lg); color: var(--text-light);">(Atual)</span></div>
              <div style="font-size: var(--font-size-xl); color: var(--text-light; margin-bottom: 10px;">${formatarMoeda(totalDistCobranca)} <span style="font-size: var(--font-size-sm);">(Distribuição)</span></div>
              <div style="font-size: var(--font-size-lg); color: ${diffCobranca >= 0 ? 'var(--success-color)' : 'var(--danger-color)'}">
                <i class="fas fa-arrow-${diffCobranca >= 0 ? 'up' : 'down'}"></i>
                ${formatarDiferencaMoeda(diffCobranca)}
              </div>
            </div>
          </div>
        `;
        
        containerDistribuicao.appendChild(summaryDivDistribuicao);
        containerDistribuicao.appendChild(tableDistribuicao);
      } else {
        containerDistribuicao.innerHTML = '<div class="chart-container"><p>Nenhum dado de distribuição disponível para comparação.</p></div>';
      }
      
      // Create comparison table for previous year if data exists
      if (dadosAnoAnterior.length > 0) {
        const tableAnoAnterior = document.createElement('table');
        tableAnoAnterior.className = 'data-table';
        tableAnoAnterior.innerHTML = `
          <thead>
            <tr>
              <th><i class="fas fa-user"></i> Distribuidor</th>
              <th><i class="fas fa-calendar-week"></i> Semana Atual</th>
              <th><i class="fas fa-calendar-alt"></i> Ano Anterior</th>
              <th><i class="fas fa-chart-line"></i> Diferença</th>
              <th><i class="fas fa-percentage"></i> Variação</th>
            </tr>
          </thead>
        `;
        
        const tbodyAnoAnterior = document.createElement('tbody');
        
        dadosSemanaAtual.forEach(itemAtual => {
          const itemAnoAnterior = dadosAnoAnterior.find(d => d.distribuidor === itemAtual.distribuidor);
          if (!itemAnoAnterior) return;
          
          const diferenca = (itemAtual.notasNovas || 0) - (itemAnoAnterior.novas || 0);
          const variacao = itemAnoAnterior.novas > 0 ? ((diferenca / itemAnoAnterior.novas) * 100).toFixed(1) : 0;
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${itemAtual.distribuidor}</strong></td>
            <td>${itemAtual.notasNovas || 0}</td>
            <td>${itemAnoAnterior.novas || 0}</td>
            <td class="text-${diferenca >= 0 ? 'success' : 'danger'}">
              <strong>${diferenca >= 0 ? '+' : ''}${diferenca}</strong>
            </td>
            <td class="text-${parseFloat(variacao) >= 0 ? 'success' : 'danger'}">
              <strong>${variacao >= 0 ? '+' : ''}${variacao}%</strong>
            </td>
          `;
          tbodyAnoAnterior.appendChild(tr);
        });
        
        tableAnoAnterior.appendChild(tbodyAnoAnterior);
        
        // Add summary section for previous year
        const totalAtualNotas = dadosSemanaAtual.reduce((sum, item) => sum + (item.notasNovas || 0), 0);
        const totalAnoAnteriorNotas = dadosAnoAnterior.reduce((sum, item) => sum + (item.novas || 0), 0);
        const diffNotasAnoAnterior = totalAtualNotas - totalAnoAnteriorNotas;
        const variacaoNotasAnoAnterior = totalAnoAnteriorNotas > 0 ? ((diffNotasAnoAnterior / totalAnoAnteriorNotas) * 100).toFixed(1) : 0;
        
        const totalAtualCobranca = dadosSemanaAtual.reduce((sum, item) => sum + (item.totalCobranca || 0), 0);
        const totalAnoAnteriorCobranca = dadosAnoAnterior.reduce((sum, item) => sum + (item.geral || 0), 0);
        const diffCobrancaAnoAnterior = totalAtualCobranca - totalAnoAnteriorCobranca;
        
        const summaryDivAnoAnterior = document.createElement('div');
        summaryDivAnoAnterior.className = 'chart-container';
        summaryDivAnoAnterior.innerHTML = `
          <h4 class="chart-title">
            <i class="fas fa-chart-pie"></i>
            Resumo Comparativo - Ano Anterior
          </h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div style="background: var(--bg-card); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-sm);">
              <div style="font-size: var(--font-size-lg); color: var(--text-light); margin-bottom: 10px;">Notas Novas</div>
              <div style="font-size: var(--font-size-2xl); font-weight: bold; margin-bottom: 5px;">${totalAtualNotas} <span style="font-size: var(--font-size-lg); color: var(--text-light);">(Atual)</span></div>
              <div style="font-size: var(--font-size-xl); color: var(--text-light); margin-bottom: 10px;">${totalAnoAnteriorNotas} <span style="font-size: var(--font-size-sm);">(Ano Anterior)</span></div>
              <div style="font-size: var(--font-size-lg; color: ${diffNotasAnoAnterior >= 0 ? 'var(--success-color)' : 'var(--danger-color)'}">
                <i class="fas fa-arrow-${diffNotasAnoAnterior >= 0 ? 'up' : 'down'}"></i>
                ${diffNotasAnoAnterior >= 0 ? '+' : ''}${diffNotasAnoAnterior} (${variacaoNotasAnoAnterior >= 0 ? '+' : ''}${variacaoNotasAnoAnterior}%)
              </div>
            </div>
            
            <div style="background: var(--bg-card); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-sm);">
              <div style="font-size: var(--font-size-lg); color: var(--text-light); margin-bottom: 10px;">Total Cobrança</div>
              <div style="font-size: var(--font-size-2xl); font-weight: bold; margin-bottom: 5px;">${formatarMoeda(totalAtualCobranca)} <span style="font-size: var(--font-size-lg); color: var(--text-light);">(Atual)</span></div>
              <div style="font-size: var(--font-size-xl); color: var(--text-light); margin-bottom: 10px;">${formatarMoeda(totalAnoAnteriorCobranca)} <span style="font-size: var(--font-size-sm);">(Ano Anterior)</span></div>
              <div style="font-size: var(--font-size-lg); color: ${diffCobrancaAnoAnterior >= 0 ? 'var(--success-color)' : 'var(--danger-color)'}">
                <i class="fas fa-arrow-${diffCobrancaAnoAnterior >= 0 ? 'up' : 'down'}"></i>
                ${formatarDiferencaMoeda(diffCobrancaAnoAnterior)}
              </div>
            </div>
          </div>
        `;
        
        containerAnoAnterior.appendChild(summaryDivAnoAnterior);
        containerAnoAnterior.appendChild(tableAnoAnterior);
      } else {
        containerAnoAnterior.innerHTML = '<div class="chart-container"><p>Nenhum dado do ano anterior disponível para comparação.</p></div>';
      }
      
      abrirModal('analiseCompletaModal');
    }

    // ===================================
    // DISTRIBUTOR DETAILS
    // ===================================
    function exibirDetalhes(nome) {
      const distribuidor = dadosSemanaAtual.find(d => d.distribuidor === nome);
      if (!distribuidor) {
        mostrarNotificacao('Distribuidor não encontrado', 'error');
        return;
      }
      
      const container = document.getElementById('distributorContent');
      container.innerHTML = '';
      
      document.getElementById('distributorModalTitle').innerHTML = `
        <i class="fas fa-user"></i>
        Dashboard: ${nome}
      `;
      
      const recorde = recordesDistribuidores[nome] || 0;
      const diferencaRecorde = recorde - (distribuidor.totalCobranca || 0);
      const bateuRecorde = distribuidor.totalCobranca > recorde;
      
      // Main dashboard
      const dashboard = document.createElement('div');
      dashboard.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <div class="stat-card">
            <i class="fas fa-bullseye stat-icon"></i>
            <div class="stat-value">${distribuidor.meta || 0}</div>
            <div class="stat-label">Objetivo Definido</div>
          </div>
          
          <div class="stat-card">
            <i class="fas fa-seedling stat-icon"></i>
            <div class="stat-value">${distribuidor.notasNovas || 0}</div>
            <div class="stat-label">Notas Novas</div>
          </div>
          
          <div class="stat-card">
            <i class="fas fa-percentage stat-icon"></i>
            <div class="stat-value text-${getPerformanceClass(distribuidor.percentualCumprimento)}">${(distribuidor.percentualCumprimento || 0).toFixed(1)}%</div>
            <div class="stat-label">Cumprimento</div>
          </div>
          
          <div class="stat-card">
            <i class="fas fa-money-bill-wave stat-icon"></i>
            <div class="stat-value text-success">${formatarMoeda(distribuidor.totalCobranca || 0)}</div>
            <div class="stat-label">Total Cobrança</div>
          </div>
          
          <div class="stat-card">
            <i class="fas fa-check-circle stat-icon"></i>
            <div class="stat-value">${distribuidor.acertadas || 0}</div>
            <div class="stat-label">Acertadas</div>
          </div>
          
          <div class="stat-card">
            <i class="fas fa-trophy stat-icon"></i>
            <div class="stat-value text-warning">${recorde > 0 ? formatarMoeda(recorde) : 'N/A'}</div>
            <div class="stat-label">Recorde Pessoal</div>
            ${bateuRecorde && recorde > 0 ? '<div class="record-badge" style="margin-top: 8px;">NOVO RECORDE!</div>' : ''}
          </div>
        </div>
      `;
      
      // Comparison with distribution week
      const dadosDist = dadosSemanaDistribuicao.find(d => d.distribuidor === nome);
      if (dadosDist) {
        const diffNotas = (distribuidor.notasNovas || 0) - (dadosDist.novas || 0);
        const diffCobr = (distribuidor.totalCobranca || 0) - (dadosDist.geral || 0);
        const variacaoNotas = dadosDist.novas > 0 ? ((diffNotas / dadosDist.novas) * 100).toFixed(1) : 0;
        
        dashboard.innerHTML += `
          <div class="chart-container">
            <h4 class="chart-title">
              <i class="fas fa-chart-line"></i>
              Comparação com Semana de Distribuição
            </h4>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Métrica</th>
                  <th>Semana Atual</th>
                  <th>Distribuição</th>
                  <th>Diferença</th>
                  <th>Variação</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Notas</strong></td>
                  <td>${distribuidor.notasNovas || 0}</td>
                  <td>${dadosDist.novas || 0}</td>
                  <td class="text-${diffNotas >= 0 ? 'success' : 'danger'}">
                    <strong>${diffNotas >= 0 ? '+' : ''}${diffNotas}</strong>
                  </td>
                  <td class="text-${parseFloat(variacaoNotas) >= 0 ? 'success' : 'danger'}">
                    <strong>${variacaoNotas >= 0 ? '+' : ''}${variacaoNotas}%</strong>
                  </td>
                </tr>
                <tr>
                  <td><strong>Total Cobrança</strong></td>
                  <td class="text-success">${formatarMoeda(distribuidor.totalCobranca || 0)}</td>
                  <td class="text-success">${formatarMoeda(dadosDist.geral || 0)}</td>
                  <td class="text-${diffCobr >= 0 ? 'success' : 'danger'}">
                    <strong>${formatarDiferencaMoeda(diffCobr)}</strong>
                  </td>
                  <td class="text-${diffCobr >= 0 ? 'success' : 'danger'}">
                    <strong>${dadosDist.geral > 0 ? ((diffCobr / dadosDist.geral) * 100).toFixed(1) : 0}%</strong>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
      }
      
      // Comparison with previous year if data exists
      const dadosAnterior = dadosAnoAnterior.find(d => d.distribuidor === nome);
      if (dadosAnterior) {
        const diffNotas = (distribuidor.notasNovas || 0) - (dadosAnterior.novas || 0);
        const diffCobr = (distribuidor.totalCobranca || 0) - (dadosAnterior.geral || 0);
        const variacaoNotas = dadosAnterior.novas > 0 ? ((diffNotas / dadosAnterior.novas) * 100).toFixed(1) : 0;
        
        dashboard.innerHTML += `
          <div class="chart-container">
            <h4 class="chart-title">
              <i class="fas fa-calendar-alt"></i>
              Comparação com Ano Anterior
            </h4>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Métrica</th>
                  <th>Semana Atual</th>
                  <th>Ano Anterior</th>
                  <th>Diferença</th>
                  <th>Variação</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Notas</strong></td>
                  <td>${distribuidor.notasNovas || 0}</td>
                  <td>${dadosAnterior.novas || 0}</td>
                  <td class="text-${diffNotas >= 0 ? 'success' : 'danger'}">
                    <strong>${diffNotas >= 0 ? '+' : ''}${diffNotas}</strong>
                  </td>
                  <td class="text-${parseFloat(variacaoNotas) >= 0 ? 'success' : 'danger'}">
                    <strong>${variacaoNotas >= 0 ? '+' : ''}${variacaoNotas}%</strong>
                  </td>
                </tr>
                <tr>
                  <td><strong>Total Cobrança</strong></td>
                  <td class="text-success">${formatarMoeda(distribuidor.totalCobranca || 0)}</td>
                  <td class="text-success">${formatarMoeda(dadosAnterior.geral || 0)}</td>
                  <td class="text-${diffCobr >= 0 ? 'success' : 'danger'}">
                    <strong>${formatarDiferencaMoeda(diffCobr)}</strong>
                  </td>
                  <td class="text-${diffCobr >= 0 ? 'success' : 'danger'}">
                    <strong>${dadosAnterior.geral > 0 ? ((diffCobr / dadosAnterior.geral) * 100).toFixed(1) : 0}%</strong>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
      }
      
      // History
      if (historicoDistribuidores[nome] && historicoDistribuidores[nome].length > 0) {
        dashboard.innerHTML += `
          <div class="chart-container">
            <h4 class="chart-title">
              <i class="fas fa-history"></i>
              Histórico Recente
            </h4>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Notas</th>
                  <th>Acertadas</th>
                  <th>Total Cobrança</th>
                  <th>Ticket Médio</th>
                  <th>% Cumprimento</th>
                </tr>
              </thead>
              <tbody>
                ${historicoDistribuidores[nome].map(entry => `
                  <tr>
                    <td><strong>${new Date(entry.data).toLocaleDateString('pt-BR')}</strong></td>
                    <td>${entry.notasNovas || 0}</td>
                    <td>${entry.acertadas || 0}</td>
                    <td class="text-success">${formatarMoeda(entry.totalCobranca || 0)}</td>
                    <td class="text-success">${entry.acertadas > 0 ? formatarMoeda(entry.totalCobranca / entry.acertadas) : 'R$ 0,00'}</td>
                    <td class="text-${getPerformanceClass(entry.meta > 0 ? ((entry.notasNovas / entry.meta) * 100).toFixed(1) : 0)}">
                      ${entry.meta > 0 ? ((entry.notasNovas / entry.meta) * 100).toFixed(1) + '%' : '0%'}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
      
      container.appendChild(dashboard);
      abrirModal('distributorModal');
    }

    // ===================================
    // UTILITY FUNCTIONS
    // ===================================
    function aplicarMascaraMoedaInput(input) {
      input.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = (parseInt(value) / 100).toFixed(2);
        value = value.replace('.', ',');
        value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        e.target.value = value;
      });
    }

    function filtrarTabela() {
      const termo = document.getElementById('searchInput').value.toLowerCase();
      dadosFiltrados = dadosSemanaAtual.filter(item => 
        item.distribuidor.toLowerCase().includes(termo)
      );
      atualizarInterface();
      updateChart();
    }

    function ordenarTabela(coluna) {
      const campos = ['distribuidor', 'meta', 'notasNovas', 'totalCobranca', 'percentualCumprimento'];
      const campo = campos[coluna];
      
      if (!sortDirection[coluna]) sortDirection[coluna] = 'asc';
      else sortDirection[coluna] = sortDirection[coluna] === 'asc' ? 'desc' : 'asc';
      
      dadosFiltrados.sort((a, b) => {
        let valorA = a[campo] || 0;
        let valorB = b[campo] || 0;
        
        if (typeof valorA === 'string') {
          valorA = valorA.toLowerCase();
          valorB = valorB.toLowerCase();
        }
        
        if (sortDirection[coluna] === 'asc') {
          return valorA < valorB ? -1 : valorA > valorB ? 1 : 0;
        } else {
          return valorA > valorB ? -1 : valorA < valorB ? 1 : 0;
        }
      });
      
      // Update sort indicators
      document.querySelectorAll('[id^="sort-"]').forEach(icon => {
        icon.className = 'fas fa-sort';
      });
      
      const sortIcon = document.getElementById(`sort-${coluna}`);
      if (sortIcon) {
        sortIcon.className = sortDirection[coluna] === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
      }
      
      atualizarInterface();
    }

    function atualizarUltimaModificacao() {
      const ultimaAtualizacao = localStorage.getItem('ultimaAtualizacao');
      if (ultimaAtualizacao) {
        const data = new Date(ultimaAtualizacao);
        document.getElementById('lastUpdate').textContent = 
          `Última atualização: ${data.toLocaleString('pt-BR')}`;
      }
    }

    // ===================================
    // EXPORT AND REPORT FUNCTIONS
    // ===================================
    function gerarRelatorioVisual() {
      if (dadosSemanaAtual.length === 0) {
        mostrarNotificacao('Carregue os dados primeiro para gerar o relatório', 'warning');
        return;
      }

      mostrarNotificacao('Gerando relatório em alta qualidade...', 'info');
      
      // Create enhanced report container
      const relatorioContainer = document.createElement('div');
      relatorioContainer.id = 'relatorioContainer';
      relatorioContainer.style.cssText = `
        width: 1200px;
        padding: 40px;
        background: #fff;
        font-family: 'Segoe UI', sans-serif;
        box-sizing: border-box;
        position: fixed;
        top: -10000px;
        left: -10000px;
        z-index: -1;
      `;
      
      // Enhanced header
      const header = document.createElement('div');
      header.style.cssText = `
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #4CAF50;
      `;
      
      header.innerHTML = `
        <h1 style="color: #4CAF50; font-size: 32px; margin: 0 0 10px 0; font-weight: 700;">
          📊 Relatório de Plantio - Desempenho Geral
        </h1>
        <div style="font-size: 18px; color: #666; margin-bottom: 15px;">
          ${document.getElementById('lastUpdate').textContent}
        </div>
        <div style="font-size: 16px; color: #888;">
          Sistema de Acompanhamento Inteligente
        </div>
      `;
      
      // Enhanced statistics
      const statsContainer = document.createElement('div');
      statsContainer.style.cssText = `
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
      `;
      
      const totalTarget = manualStats.totalTarget !== null ? manualStats.totalTarget : 
                         dadosSemanaAtual.reduce((sum, item) => sum + (item.meta || 0), 0);
      const totalProgress = manualStats.totalProgress !== null ? manualStats.totalProgress : 
                           dadosSemanaAtual.reduce((sum, item) => sum + (item.notasNovas || 0), 0);
      const pendentes = Math.max(0, totalTarget - totalProgress);
      const totalDistributors = dadosSemanaAtual.length;
      
      statsContainer.innerHTML = `
        <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; border-radius: 12px; text-align: center;">
          <div style="font-size: 44px; font-weight: bold; margin-bottom: 8px;">🎯 ${totalTarget.toLocaleString('pt-BR')}</div>
          <div style="font-size: 28px; opacity: 0.9;">Objetivo Total</div>
        </div>
        <div style="background: linear-gradient(135deg, #2196F3, #0b7dda); color: white; padding: 20px; border-radius: 12px; text-align: center;">
          <div style="font-size: 44px; font-weight: bold; margin-bottom: 8px;">📈 ${totalProgress.toLocaleString('pt-BR')}</div>
          <div style="font-size: 28px; opacity: 0.9;">Progresso Atual</div>
        </div>
        <div style="background: linear-gradient(135deg, #FF9800, #e68a00); color: white; padding: 20px; border-radius: 12px; text-align: center;">
          <div style="font-size: 44px; font-weight: bold; margin-bottom: 8px;">📊 ${pendentes.toLocaleString('pt-BR')}</div>
          <div style="font-size: 28px; opacity: 0.9;">Pendentes</div>
        </div>
        <div style="background: linear-gradient(135deg, #9C27B0, #7B1FA2); color: white; padding: 20px; border-radius: 12px; text-align: center;">
          <div style="font-size: 44px; font-weight: bold; margin-bottom: 8px;">👥 ${totalDistributors}</div>
          <div style="font-size: 28px; opacity: 0.9;">Distribuidores</div>
        </div>
      `;
      
      // Enhanced table
      const tableContainer = document.createElement('div');
      tableContainer.style.cssText = `
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
      `;
      
      const table = document.createElement('table');
      table.style.cssText = `
        width: 100%;
        border-collapse: collapse;
        font-size: 16px;
        background: white;
      `;
      
      // Table header
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th style="padding: 28px; text-align: left; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; font-size: 28px; font-weight: 600;">🏢 Distribuidor</th>
          <th style="padding: 22px; text-align: center; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; font-size: 22px; font-weight: 600;">📊 %</th>
          <th style="padding: 22px; text-align: center; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; font-size: 22px; font-weight: 600;">📈 Progresso</th>
        </tr>
      `;
      table.appendChild(thead);

      // Table body
      const tbody = document.createElement('tbody');
      const dadosOrdenados = [...dadosSemanaAtual].sort((a,b) => (b.percentualCumprimento||0) - (a.percentualCumprimento||0));

      dadosOrdenados.forEach((item, index) => {
        const p = (item.percentualCumprimento||0).toFixed(1);
        const tr = document.createElement('tr');
        
        const bgColor = index % 2 === 0 ? '#fff' : '#f8f9fa';
        const performanceColor = getColorForPercentage(p);
        
        tr.style.cssText = `background: ${bgColor}; border-bottom: 1px solid #eee;`;
        
        tr.innerHTML = `
          <td style="padding: 30px; font-weight: 900; color: #333; font-size: 32px;">${item.distribuidor}</td>
          <td style="padding: 16px; text-align: center; font-weight: bold; color: ${performanceColor}; font-size: 32px;">${p}%</td>
          <td style="padding: 16px; text-align: center;">
            <div style="height: 24px; background: #e0e0e0; border-radius: 12px; overflow: hidden; position: relative; width: 120px; margin: 0 auto;">
              <div style="height: 100%; background: ${performanceColor}; width: ${Math.min(100, p)}%; border-radius: 12px;"></div>
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 22px; font-weight: bold; color: #333;">${p}%</div>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      table.appendChild(tbody);
      tableContainer.appendChild(table);
      
      // Enhanced footer
      const footer = document.createElement('div');
      footer.style.cssText = `
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #4CAF50;
        color: #666;
      `;
      
      footer.innerHTML = `
        <div style="font-size: 18px; color: #4CAF50; margin-bottom: 10px;">
          🌱 Sistema de Acompanhamento de Plantio
        </div>
        <div style="font-size: 14px;">
          Relatório gerado automaticamente em ${new Date().toLocaleString('pt-BR')}
        </div>
      `;
      
      // Assemble report
      relatorioContainer.appendChild(header);
      relatorioContainer.appendChild(statsContainer);
      relatorioContainer.appendChild(tableContainer);
      relatorioContainer.appendChild(footer);
      
      document.body.appendChild(relatorioContainer);
      
      // Generate image
      html2canvas(relatorioContainer, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        logging: true,
        onclone: function(clonedDoc) {
          const clonedContainer = clonedDoc.getElementById('relatorioContainer');
          if (clonedContainer) {
            clonedContainer.style.position = 'absolute';
            clonedContainer.style.left = '0';
            clonedContainer.style.top = '0';
          }
        }
      }).then(canvas => {
        // Create download link
        const link = document.createElement('a');
        link.download = `relatorio_plantio_${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL('image/png', 1.0);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Remove temporary container
        document.body.removeChild(relatorioContainer);
        
        mostrarNotificacao('Relatório gerado e baixado com sucesso!', 'success');
      }).catch(error => {
        console.error('Erro ao gerar relatório:', error);
        document.body.removeChild(relatorioContainer);
        mostrarNotificacao('Erro ao gerar relatório visual', 'error');
      });
    }

    function gerarRelatorioSemCobranca() {
      if (dadosSemanaAtual.length === 0) {
        mostrarNotificacao('Carregue os dados primeiro para gerar o relatório', 'warning');
        return;
      }

      mostrarNotificacao('Gerando relatório sem valores de cobrança...', 'info');
      
      // Create enhanced report container
      const relatorioContainer = document.createElement('div');
      relatorioContainer.id = 'relatorioContainer';
      relatorioContainer.style.cssText = `
        width: 1200px;
        padding: 40px;
        background: #fff;
        font-family: 'Segoe UI', sans-serif;
        box-sizing: border-box;
        position: fixed;
        top: -10000px;
        left: -10000px;
        z-index: -1;
      `;
      
      // Enhanced header
      const header = document.createElement('div');
      header.style.cssText = `
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #4CAF50;
      `;
      
      header.innerHTML = `
        <h1 style="color: #4CAF50; font-size: 32px; margin: 0 0 10px 0; font-weight: 700;">
          📊 Relatório de Plantio - Sem Valores de Cobrança
        </h1>
        <div style="font-size: 18px; color: #666; margin-bottom: 15px;">
          ${document.getElementById('lastUpdate').textContent}
        </div>
        <div style="font-size: 16px; color: #888;">
          Sistema de Acompanhamento Inteligente
        </div>
      `;
      
      // Enhanced statistics
      const statsContainer = document.createElement('div');
      statsContainer.style.cssText = `
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 30px;
      `;
      
      const totalTarget = manualStats.totalTarget !== null ? manualStats.totalTarget : 
                         dadosSemanaAtual.reduce((sum, item) => sum + (item.meta || 0), 0);
      const totalProgress = manualStats.totalProgress !== null ? manualStats.totalProgress : 
                           dadosSemanaAtual.reduce((sum, item) => sum + (item.notasNovas || 0), 0);
      const pendentes = Math.max(0, totalTarget - totalProgress);
      
      statsContainer.innerHTML = `
        <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; border-radius: 12px; text-align: center;">
          <div style="font-size: 44px; font-weight: bold; margin-bottom: 8px;">🎯 ${totalTarget.toLocaleString('pt-BR')}</div>
          <div style="font-size: 28px; opacity: 0.9;">Objetivo Total</div>
        </div>
        <div style="background: linear-gradient(135deg, #2196F3, #0b7dda); color: white; padding: 20px; border-radius: 12px; text-align: center;">
          <div style="font-size: 44px; font-weight: bold; margin-bottom: 8px;">📈 ${totalProgress.toLocaleString('pt-BR')}</div>
          <div style="font-size: 28px; opacity: 0.9;">Progresso Atual</div>
        </div>
        <div style="background: linear-gradient(135deg, #FF9800, #e68a00); color: white; padding: 20px; border-radius: 12px; text-align: center;">
          <div style="font-size: 44px; font-weight: bold; margin-bottom: 8px;">📊 ${pendentes.toLocaleString('pt-BR')}</div>
          <div style="font-size: 28px; opacity: 0.9;">Pendentes</div>
        </div>
      `;
      
      // Enhanced table
      const tableContainer = document.createElement('div');
      tableContainer.style.cssText = `
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
      `;
      
      const table = document.createElement('table');
      table.style.cssText = `
        width: 100%;
        border-collapse: collapse;
        font-size: 16px;
        background: white;
      `;
      
      // Table header
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th style="padding: 28px; text-align: left; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; font-size: 28px; font-weight: 600;">🏢 Distribuidor</th>
          <th style="padding: 22px; text-align: center; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; font-size: 22px; font-weight: 600;">🎯 Objetivo</th>
          <th style="padding: 22px; text-align: center; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; font-size: 22px; font-weight: 600;">📈 Notas</th>
          <th style="padding: 22px; text-align: center; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; font-size: 22px; font-weight: 600;">📊 %</th>
        </tr>
      `;
      table.appendChild(thead);

      // Table body
      const tbody = document.createElement('tbody');
      const dadosOrdenados = [...dadosSemanaAtual].sort((a,b) => (b.percentualCumprimento||0) - (a.percentualCumprimento||0));

      dadosOrdenados.forEach((item, index) => {
        const p = (item.percentualCumprimento||0).toFixed(1);
        const tr = document.createElement('tr');
        
        const bgColor = index % 2 === 0 ? '#fff' : '#f8f9fa';
        const performanceColor = getColorForPercentage(p);
        
        tr.style.cssText = `background: ${bgColor}; border-bottom: 1px solid #eee;`;
        
        tr.innerHTML = `
          <td style="padding: 30px; font-weight: 900; color: #333; font-size: 32px;">${item.distribuidor}</td>
          <td style="padding: 16px; text-align: center; font-weight: bold; font-size: 32px;">${item.meta || 0}</td>
          <td style="padding: 16px; text-align: center; font-weight: bold; font-size: 32px;">${item.notasNovas || 0}</td>
          <td style="padding: 16px; text-align: center; font-weight: bold; color: ${performanceColor}; font-size: 32px;">${p}%</td>
        `;
        tbody.appendChild(tr);
      });
      
      table.appendChild(tbody);
      tableContainer.appendChild(table);
      
      // Enhanced footer
      const footer = document.createElement('div');
      footer.style.cssText = `
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #4CAF50;
        color: #666;
      `;
      
      footer.innerHTML = `
        <div style="font-size: 18px; color: #4CAF50; margin-bottom: 10px;">
          🌱 Sistema de Acompanhamento de Plantio
        </div>
        <div style="font-size: 14px;">
          Relatório gerado automaticamente em ${new Date().toLocaleString('pt-BR')}
        </div>
      `;
      
      // Assemble report
      relatorioContainer.appendChild(header);
      relatorioContainer.appendChild(statsContainer);
      relatorioContainer.appendChild(tableContainer);
      relatorioContainer.appendChild(footer);
      
      document.body.appendChild(relatorioContainer);
      
      // Generate image
      html2canvas(relatorioContainer, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        logging: true,
        onclone: function(clonedDoc) {
          const clonedContainer = clonedDoc.getElementById('relatorioContainer');
          if (clonedContainer) {
            clonedContainer.style.position = 'absolute';
            clonedContainer.style.left = '0';
            clonedContainer.style.top = '0';
          }
        }
      }).then(canvas => {
        // Create download link
        const link = document.createElement('a');
        link.download = `relatorio_plantio_sem_cobranca_${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL('image/png', 1.0);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Remove temporary container
        document.body.removeChild(relatorioContainer);
        
        mostrarNotificacao('Relatório sem cobrança gerado e baixado com sucesso!', 'success');
      }).catch(error => {
        console.error('Erro ao gerar relatório:', error);
        document.body.removeChild(relatorioContainer);
        mostrarNotificacao('Erro ao gerar relatório visual', 'error');
      });
    }

    function limparDados() {
      if (confirm('⚠️ Tem certeza que deseja limpar todos os dados? Esta ação não pode ser desfeita.')) {
        try {
          localStorage.clear();
          
          // Reset variables
          dadosSemanaAtual = [];
          dadosSemanaDistribuicao = [];
          dadosAnoAnterior = [];
          dadosFiltrados = [];
          metasDefinidas = {};
          recordesDistribuidores = {};
          historicoDistribuidores = {};
          manualStats = {
            totalTarget: null,
            totalProgress: null
          };
          semanasData = {};
          semanaAtual = null;
          
          // Destroy chart
          if (performanceChart) {
            performanceChart.destroy();
            performanceChart = null;
          }
          
          atualizarInterface();
          document.getElementById('lastUpdate').textContent = 'Aguardando dados...';
          document.getElementById('comparisonContainer').style.display = 'none';
          document.getElementById('weekIndicator').textContent = '';
          
          mostrarNotificacao('Todos os dados foram limpos com sucesso!', 'success');
          
        } catch (error) {
          console.error('Erro ao limpar dados:', error);
          mostrarNotificacao('Erro ao limpar dados', 'error');
        }
      }
    }

    function mostrarDashboard() {
      // Update active button
      document.querySelectorAll('.btn-sidebar').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.closest('.btn-sidebar').classList.add('active');
      
      // Focus on main content (already visible)
      mostrarNotificacao('Dashboard principal carregado', 'info');
    }

    // ===================================
    // INITIALIZATION
    // ===================================
    function inicializar() {
      console.log('🌱 Iniciando Sistema de Acompanhamento de Plantio...');
      
      // Load theme
      loadTheme();
      
      // Load saved data
      carregarDadosLocais();
      
      // Update interface
      atualizarInterface();
      atualizarComparativos();
      
      // Update chart if data exists
      if (dadosFiltrados.length > 0) {
        updateChart();
      }
      
      console.log('✅ Sistema inicializado com sucesso!');
      
      // Welcome message
      setTimeout(() => {
        if (dadosSemanaAtual.length === 0) {
          mostrarNotificacao('Bem-vindo! Importe seus dados para começar.', 'info');
        } else {
          mostrarNotificacao(`Sistema carregado com ${dadosSemanaAtual.length} distribuidores`, 'success');
        }
      }, 1000);
    }

    // Start application when DOM is ready
    document.addEventListener('DOMContentLoaded', inicializar);
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl+I or Cmd+I - Import data
      if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
        e.preventDefault();
        abrirModal('dataModal');
      }
      
      // Ctrl+E or Cmd+E - Toggle edit mode
      if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        toggleEditMode();
      }
      
      // Ctrl+S or Cmd+S - Save changes (if in edit mode)
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (modoEdicaoManual) {
          salvarAlteracoes();
        }
      }
      
      // Escape - Close modals
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal').forEach(modal => {
          if (modal.style.display === 'block') {
            fecharModal(modal.id);
          }
        });
        
        // Also close data view if open
        if (document.getElementById('dataView').style.display === 'block') {
          fecharVisualizacaoDados();
        }
      }
    });

    // Console welcome message
    console.log(`
    🌱 Sistema de Acompanhamento de Plantio - Versão Melhorada
    =========================================
    ✨ Funcionalidades disponíveis:
    • 📊 Dashboard interativo com gráficos
    • 📅 Sistema de gerenciamento por semanas (1-52)
    • 👁️ Visualização completa dos dados do plantio
    • 📈 Análise comparativa avançada (vs Distribuição e vs Ano Anterior)
    • 🎯 Gestão de metas individuais
    • 🏆 Sistema de recordes pessoais
    • 📱 Interface responsiva
    • 🌙 Suporte a tema escuro
    • ⌨️  Atalhos de teclado
    • 💾 Armazenamento local automático
    
    Desenvolvido com ❤️ para otimizar sua gestão!
    `);

  </script>
</body>
</html>
